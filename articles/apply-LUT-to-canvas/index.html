<!DOCTYPE >
<html>
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>LUT apply color correction from CUBE</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/default.min.css">
    <link rel="preconnect" href="https://fonts.gstatic.com">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+KR:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/articles/styles/highlight.css">
    <link rel="stylesheet" href="/articles/styles/header.css">
    <link rel="stylesheet" href="/articles/styles/content.css">
    <link rel="stylesheet" href="/articles/styles/markdown.css">
    <style rel="stylesheet">
      mjx-container[jax="SVG"] > svg {
         max-width: 100%;
      }
    </style>
    <link rel="stylesheet" href="/articles/styles/typography.css">
    
  <style id="MJX-SVG-styles">
mjx-container[jax="SVG"] {
  direction: ltr;
}

mjx-container[jax="SVG"] > svg {
  overflow: visible;
  min-height: 1px;
  min-width: 1px;
}

mjx-container[jax="SVG"] > svg a {
  fill: blue;
  stroke: blue;
}

mjx-assistive-mml {
  position: absolute !important;
  top: 0px;
  left: 0px;
  clip: rect(1px, 1px, 1px, 1px);
  padding: 1px 0px 0px 0px !important;
  border: 0px !important;
  display: block !important;
  width: auto !important;
  overflow: hidden !important;
  -webkit-touch-callout: none;
  -webkit-user-select: none;
  -khtml-user-select: none;
  -moz-user-select: none;
  -ms-user-select: none;
  user-select: none;
}

mjx-assistive-mml[display="block"] {
  width: 100% !important;
}

mjx-container[jax="SVG"][display="true"] {
  display: block;
  text-align: center;
  margin: 1em 0;
}

mjx-container[jax="SVG"][display="true"][width="full"] {
  display: flex;
}

mjx-container[jax="SVG"][justify="left"] {
  text-align: left;
}

mjx-container[jax="SVG"][justify="right"] {
  text-align: right;
}

g[data-mml-node="merror"] > g {
  fill: red;
  stroke: red;
}

g[data-mml-node="merror"] > rect[data-background] {
  fill: yellow;
  stroke: none;
}

g[data-mml-node="mtable"] > line[data-line], svg[data-table] > g > line[data-line] {
  stroke-width: 70px;
  fill: none;
}

g[data-mml-node="mtable"] > rect[data-frame], svg[data-table] > g > rect[data-frame] {
  stroke-width: 70px;
  fill: none;
}

g[data-mml-node="mtable"] > .mjx-dashed, svg[data-table] > g > .mjx-dashed {
  stroke-dasharray: 140;
}

g[data-mml-node="mtable"] > .mjx-dotted, svg[data-table] > g > .mjx-dotted {
  stroke-linecap: round;
  stroke-dasharray: 0,140;
}

g[data-mml-node="mtable"] > g > svg {
  overflow: visible;
}

[jax="SVG"] mjx-tool {
  display: inline-block;
  position: relative;
  width: 0;
  height: 0;
}

[jax="SVG"] mjx-tool > mjx-tip {
  position: absolute;
  top: 0;
  left: 0;
}

mjx-tool > mjx-tip {
  display: inline-block;
  padding: .2em;
  border: 1px solid #888;
  font-size: 70%;
  background-color: #F8F8F8;
  color: black;
  box-shadow: 2px 2px 5px #AAAAAA;
}

g[data-mml-node="maction"][data-toggle] {
  cursor: pointer;
}

mjx-status {
  display: block;
  position: fixed;
  left: 1em;
  bottom: 1em;
  min-width: 25%;
  padding: .2em .4em;
  border: 1px solid #888;
  font-size: 90%;
  background-color: #F8F8F8;
  color: black;
}

foreignObject[data-mjx-xml] {
  font-family: initial;
  line-height: normal;
  overflow: visible;
}

mjx-container[jax="SVG"] path[data-c], mjx-container[jax="SVG"] use[data-c] {
  stroke-width: 3;
}
</style></head>

  <body>
    <layout>
      <header>
        <h1>
          LUT apply color correction from CUBE
        </h1>
      </header>
      <main>
        <article class="markdown">
          <h2>This article explores how to apply LUT color correction to a canvas</h2>
          <div class="content">
            <style>
    .global-theme-select {
        position: sticky;
        top: 0;
        left: 0;
        z-index: 1000;
        font-size: 20px;
        width: 100%;
        background-color: white;
        padding-bottom: 10px;
    }
    .global-theme-select select {
        font-size: 50px;
    }
</style>
<div class="global-theme-select">
    <theme-selector></theme-selector>
</div>
<blockquote>
<p>This article contains interactive demos that respond to the selected color palette. Feel free to experiment with different palettes to see how the demos react.</p>
</blockquote>
<blockquote>
<p>Each demo is essentially an iframe pointing to a separate folder with its source code. You can open any of them in a debugger to explore how they work without interfering with other demos.
All demos are written in plain JavaScript without any build tools</p>
</blockquote>
<h2>Introduction</h2>
<p>Let's imagine we have an image or video and we need to remap the colors in it to match a specific color palette. This is a common task in animation and video production. In previous article we discussed how to apply color channel mapping algorithm.
The main problem with that that we would need to prepare assets in a specific way. It produces good results for simple media, but it is not very flexible.
In this article we will explor LUT (Look-Up Table) color correction. LUT is a table that maps one color to another. It can be used to remap colors in an image or video to match a specific color palette.</p>
<ul>
<li>Code-based animation</li>
<li>SVG-based animation</li>
<li>Solid color remapping</li>
</ul>
<p>Let's dive into each approach.</p>
<h2>Code-based animation</h2>
<p>Imagine the animation is created using code that draws on a canvas. For example:</p>
<pre class="language-typescript"><code class="language-typescript"><span class="token keyword">function</span> <span class="token function">drawCircle</span><span class="token punctuation">(</span>ctx<span class="token operator">:</span> CanvasRenderingContext2D<span class="token punctuation">,</span> x<span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">,</span> y<span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">,</span> r<span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  ctx<span class="token punctuation">.</span><span class="token function">beginPath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  ctx<span class="token punctuation">.</span>fillStyle <span class="token operator">=</span> <span class="token string">'red'</span><span class="token punctuation">;</span>
  ctx<span class="token punctuation">.</span><span class="token function">arc</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span> y<span class="token punctuation">,</span> r<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">2</span> <span class="token operator">*</span> Math<span class="token punctuation">.</span><span class="token constant">PI</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  ctx<span class="token punctuation">.</span><span class="token function">fill</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre>
<p><demo-with-playground file="./code-based-animation/index.mjs" initialPath="./code-based-animation/index.html"></demo-with-playground></p>
<p>To make the animation recolorable, we can pass the palette to the function and use the colors from it in the code, like this:</p>
<pre class="language-typescript"><code class="language-typescript"><span class="token keyword">function</span> <span class="token function">drawCircle</span><span class="token punctuation">(</span>ctx<span class="token operator">:</span> CanvasRenderingContext2D<span class="token punctuation">,</span> x<span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">,</span> y<span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">,</span> r<span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">,</span> colorPalette<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">,</span> <span class="token builtin">string</span><span class="token punctuation">,</span> <span class="token builtin">string</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  ctx<span class="token punctuation">.</span><span class="token function">beginPath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  ctx<span class="token punctuation">.</span>fillStyle <span class="token operator">=</span> colorPalette<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  ctx<span class="token punctuation">.</span><span class="token function">arc</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span> y<span class="token punctuation">,</span> r<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">2</span> <span class="token operator">*</span> Math<span class="token punctuation">.</span><span class="token constant">PI</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  ctx<span class="token punctuation">.</span><span class="token function">fill</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre>
<p>The downside of this approach is that only developers can create such animations; without programming skills, it's impossible.</p>
<h2>SVG-based animation</h2>
<p>Now, let's imagine the animation is created using SVG. For example:</p>
<pre class="language-xml"><code class="language-xml"><span class="token prolog">&lt;?xml version="1.0"?&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>svg</span> <span class="token attr-name">viewBox</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>0 0 60 60<span class="token punctuation">"</span></span> <span class="token attr-name">version</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>1.1<span class="token punctuation">"</span></span>
  <span class="token attr-name">xmlns</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>http://www.w3.org/2000/svg<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>circle</span> <span class="token attr-name">cx</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>60<span class="token punctuation">"</span></span> <span class="token attr-name">cy</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>60<span class="token punctuation">"</span></span> <span class="token attr-name">r</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>50<span class="token punctuation">"</span></span><span class="token punctuation">/&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>svg</span><span class="token punctuation">&gt;</span></span></code></pre>
<p>We can then create a function to recolor the SVG based on the desired palette:</p>
<pre class="language-typescript"><code class="language-typescript"><span class="token keyword">function</span> <span class="token function">recolorSVG</span><span class="token punctuation">(</span>svg<span class="token punctuation">,</span> colorPalette<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">,</span> <span class="token builtin">string</span><span class="token punctuation">,</span> <span class="token builtin">string</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> parser <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DOMParser</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> doc <span class="token operator">=</span> parser<span class="token punctuation">.</span><span class="token function">parseFromString</span><span class="token punctuation">(</span>svg<span class="token punctuation">,</span> <span class="token string">"image/svg+xml"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> elements <span class="token operator">=</span> doc<span class="token punctuation">.</span><span class="token function">querySelectorAll</span><span class="token punctuation">(</span><span class="token string">'[fill]'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  elements<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span>element<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> colorIndex <span class="token operator">=</span> element<span class="token punctuation">.</span><span class="token function">getAttribute</span><span class="token punctuation">(</span><span class="token string">'fill'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    element<span class="token punctuation">.</span><span class="token function">setAttribute</span><span class="token punctuation">(</span><span class="token string">'fill'</span><span class="token punctuation">,</span> colors<span class="token punctuation">[</span>colorIndex<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> doc<span class="token punctuation">.</span>documentElement<span class="token punctuation">.</span>outerHTML<span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre>
<p><demo-with-playground file="./svg-based-animation/index.mjs" initialPath="./svg-based-animation/index.html"></demo-with-playground></p>
<p>Designers can mark elements so that we know which color from the palette corresponds to each element. For example:</p>
<pre class="language-xml"><code class="language-xml"><span class="token prolog">&lt;?xml version="1.0"?&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>svg</span> <span class="token attr-name">viewBox</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>0 0 60 60<span class="token punctuation">"</span></span> <span class="token attr-name">version</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>1.1<span class="token punctuation">"</span></span>
  <span class="token attr-name">xmlns</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>http://www.w3.org/2000/svg<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>circle</span> <span class="token attr-name">cx</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>60<span class="token punctuation">"</span></span> <span class="token attr-name">cy</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>60<span class="token punctuation">"</span></span> <span class="token attr-name">r</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>50<span class="token punctuation">"</span></span> <span class="token attr-name">fill</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>1<span class="token punctuation">"</span></span><span class="token punctuation">/&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>svg</span><span class="token punctuation">&gt;</span></span></code></pre>
<p>Unfortunately, despite the long-standing existence of the SVG animation standard, not many design tools can export animations to SVG. This means designers often still need some programming skills.</p>
<h2>Solid color remapping</h2>
<p>For designers, it is often easiest to create an animation in a tool of their choice and export it as a video. Most animation tools support this.</p>
<p>But how can the designer mark elements in the video so we can recolor them? One solution is for the designer to create a video with three colors—RGB.</p>
<p>This video might look like this:</p>
<p>How can we recolor this video using the chosen palette?</p>
<pre class="language-javascript"><code class="language-javascript"><span class="token keyword">const</span> canvas <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">'canvas'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> ctx <span class="token operator">=</span> canvas<span class="token punctuation">.</span><span class="token function">getContext</span><span class="token punctuation">(</span><span class="token string">'2d'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">function</span> <span class="token function">drawFrame</span><span class="token punctuation">(</span><span class="token parameter">video</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    ctx<span class="token punctuation">.</span><span class="token function">drawImage</span><span class="token punctuation">(</span>vide<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">const</span> imageData <span class="token operator">=</span> ctx<span class="token punctuation">.</span><span class="token function">getImageData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">replaceColors</span><span class="token punctuation">(</span>imageData<span class="token punctuation">,</span> colorPalette<span class="token punctuation">)</span><span class="token punctuation">;</span>

    ctx<span class="token punctuation">.</span><span class="token function">putImageData</span><span class="token punctuation">(</span>imageData<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">relaceColors</span><span class="token punctuation">(</span><span class="token parameter">imageData<span class="token punctuation">,</span> colorPalette</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> imageData<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">+=</span><span class="token number">3</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> image <span class="token operator">=</span> imageData<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token keyword">const</span> r <span class="token operator">=</span> imageData<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token keyword">const</span> g <span class="token operator">=</span> imageData<span class="token punctuation">[</span>i<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token keyword">const</span> b <span class="token operator">=</span> imageData<span class="token punctuation">[</span>i<span class="token operator">+</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">getNewColor</span><span class="token punctuation">(</span><span class="token parameter">old<span class="token punctuation">,</span> colorPalette</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
   <span class="token keyword">return</span> old<span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre>
<p><demo-with-playground file="./solid-color-remapping/index.mjs" initialPath="./solid-color-remapping/index.html"></demo-with-playground></p>
<p>In this example, it's hard to notice, but the border of the circle has a slightly different color. This happens because the border's color is not a solid color but a gradient due to anti-aliasing.</p>
<p><a href="solid-color-remapping/antialiasing.png"><img src="solid-color-remapping/antialiasing.png" alt="Gradient border"></a></p>
<p>A more obvious example is replacing the color of an image with a gradient:</p>
<p><demo-with-playground file="./gradient-color-remapping/index.mjs" initialPath="./gradient-color-remapping/index.html"></demo-with-playground></p>
<p>As you can see, this is not what we expected. The final image should only contain colors from the palette, but we see additional colors. You might also notice that the gradient is no longer smooth.</p>
<p>This is where color channel mapping comes in.</p>
<h2>Color channel mapping</h2>
<p>The basic idea is to create a matrix that maps the original color to the target color.</p>
<p>
<mjx-container class="MathJax" jax="SVG" display="true" style="position: relative;"><svg style="vertical-align: -3.733ex;" xmlns="http://www.w3.org/2000/svg" width="61.143ex" height="8.597ex" role="img" focusable="false" viewBox="0 -2150 27025 3800" xmlns:xlink="http://www.w3.org/1999/xlink" aria-hidden="true"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mrow"><g data-mml-node="mo"><use data-c="23A1" xlink:href="#MJX-TEX-S4-23A1" transform="translate(0,996)"></use><use data-c="23A3" xlink:href="#MJX-TEX-S4-23A3" transform="translate(0,-1006)"></use><svg width="667" height="402" y="49" x="0" viewBox="0 100.5 667 402"><use data-c="23A2" xlink:href="#MJX-TEX-S4-23A2" transform="scale(1,1.002)"></use></svg></g><g data-mml-node="mtable" transform="translate(667,0)"><g data-mml-node="mtr" transform="translate(0,1400)"><g data-mml-node="mtd" transform="translate(24.5,0)"><g data-mml-node="mtext"><use data-c="66" xlink:href="#MJX-TEX-N-66"></use><use data-c="69" xlink:href="#MJX-TEX-N-69" transform="translate(306,0)"></use><use data-c="6E" xlink:href="#MJX-TEX-N-6E" transform="translate(584,0)"></use><use data-c="61" xlink:href="#MJX-TEX-N-61" transform="translate(1140,0)"></use><use data-c="6C" xlink:href="#MJX-TEX-N-6C" transform="translate(1640,0)"></use><use data-c="52" xlink:href="#MJX-TEX-N-52" transform="translate(1918,0)"></use></g></g></g><g data-mml-node="mtr"><g data-mml-node="mtd"><g data-mml-node="mtext"><use data-c="66" xlink:href="#MJX-TEX-N-66"></use><use data-c="69" xlink:href="#MJX-TEX-N-69" transform="translate(306,0)"></use><use data-c="6E" xlink:href="#MJX-TEX-N-6E" transform="translate(584,0)"></use><use data-c="61" xlink:href="#MJX-TEX-N-61" transform="translate(1140,0)"></use><use data-c="6C" xlink:href="#MJX-TEX-N-6C" transform="translate(1640,0)"></use><use data-c="47" xlink:href="#MJX-TEX-N-47" transform="translate(1918,0)"></use></g></g></g><g data-mml-node="mtr" transform="translate(0,-1400)"><g data-mml-node="mtd" transform="translate(38.5,0)"><g data-mml-node="mtext"><use data-c="66" xlink:href="#MJX-TEX-N-66"></use><use data-c="69" xlink:href="#MJX-TEX-N-69" transform="translate(306,0)"></use><use data-c="6E" xlink:href="#MJX-TEX-N-6E" transform="translate(584,0)"></use><use data-c="61" xlink:href="#MJX-TEX-N-61" transform="translate(1140,0)"></use><use data-c="6C" xlink:href="#MJX-TEX-N-6C" transform="translate(1640,0)"></use><use data-c="42" xlink:href="#MJX-TEX-N-42" transform="translate(1918,0)"></use></g></g></g></g><g data-mml-node="mo" transform="translate(3370,0)"><use data-c="23A4" xlink:href="#MJX-TEX-S4-23A4" transform="translate(0,996)"></use><use data-c="23A6" xlink:href="#MJX-TEX-S4-23A6" transform="translate(0,-1006)"></use><svg width="667" height="402" y="49" x="0" viewBox="0 100.5 667 402"><use data-c="23A5" xlink:href="#MJX-TEX-S4-23A5" transform="scale(1,1.002)"></use></svg></g></g><g data-mml-node="mo" transform="translate(4314.8,0)"><use data-c="3D" xlink:href="#MJX-TEX-N-3D"></use></g><g data-mml-node="mrow" transform="translate(5370.6,0)"><g data-mml-node="mo"><use data-c="23A1" xlink:href="#MJX-TEX-S4-23A1" transform="translate(0,996)"></use><use data-c="23A3" xlink:href="#MJX-TEX-S4-23A3" transform="translate(0,-1006)"></use><svg width="667" height="402" y="49" x="0" viewBox="0 100.5 667 402"><use data-c="23A2" xlink:href="#MJX-TEX-S4-23A2" transform="scale(1,1.002)"></use></svg></g><g data-mml-node="mtable" transform="translate(667,0)"><g data-mml-node="mtr" transform="translate(0,1400)"><g data-mml-node="mtd" transform="translate(24.5,0)"><g data-mml-node="mtext"><use data-c="74" xlink:href="#MJX-TEX-N-74"></use><use data-c="61" xlink:href="#MJX-TEX-N-61" transform="translate(389,0)"></use><use data-c="72" xlink:href="#MJX-TEX-N-72" transform="translate(889,0)"></use><use data-c="67" xlink:href="#MJX-TEX-N-67" transform="translate(1281,0)"></use><use data-c="65" xlink:href="#MJX-TEX-N-65" transform="translate(1781,0)"></use><use data-c="74" xlink:href="#MJX-TEX-N-74" transform="translate(2225,0)"></use><use data-c="31" xlink:href="#MJX-TEX-N-31" transform="translate(2614,0)"></use><use data-c="52" xlink:href="#MJX-TEX-N-52" transform="translate(3114,0)"></use></g></g><g data-mml-node="mtd" transform="translate(4923.5,0)"><g data-mml-node="mtext"><use data-c="74" xlink:href="#MJX-TEX-N-74"></use><use data-c="61" xlink:href="#MJX-TEX-N-61" transform="translate(389,0)"></use><use data-c="72" xlink:href="#MJX-TEX-N-72" transform="translate(889,0)"></use><use data-c="67" xlink:href="#MJX-TEX-N-67" transform="translate(1281,0)"></use><use data-c="65" xlink:href="#MJX-TEX-N-65" transform="translate(1781,0)"></use><use data-c="74" xlink:href="#MJX-TEX-N-74" transform="translate(2225,0)"></use><use data-c="32" xlink:href="#MJX-TEX-N-32" transform="translate(2614,0)"></use><use data-c="52" xlink:href="#MJX-TEX-N-52" transform="translate(3114,0)"></use></g></g><g data-mml-node="mtd" transform="translate(9822.5,0)"><g data-mml-node="mtext"><use data-c="74" xlink:href="#MJX-TEX-N-74"></use><use data-c="61" xlink:href="#MJX-TEX-N-61" transform="translate(389,0)"></use><use data-c="72" xlink:href="#MJX-TEX-N-72" transform="translate(889,0)"></use><use data-c="67" xlink:href="#MJX-TEX-N-67" transform="translate(1281,0)"></use><use data-c="65" xlink:href="#MJX-TEX-N-65" transform="translate(1781,0)"></use><use data-c="74" xlink:href="#MJX-TEX-N-74" transform="translate(2225,0)"></use><use data-c="33" xlink:href="#MJX-TEX-N-33" transform="translate(2614,0)"></use><use data-c="52" xlink:href="#MJX-TEX-N-52" transform="translate(3114,0)"></use></g></g></g><g data-mml-node="mtr"><g data-mml-node="mtd"><g data-mml-node="mtext"><use data-c="74" xlink:href="#MJX-TEX-N-74"></use><use data-c="61" xlink:href="#MJX-TEX-N-61" transform="translate(389,0)"></use><use data-c="72" xlink:href="#MJX-TEX-N-72" transform="translate(889,0)"></use><use data-c="67" xlink:href="#MJX-TEX-N-67" transform="translate(1281,0)"></use><use data-c="65" xlink:href="#MJX-TEX-N-65" transform="translate(1781,0)"></use><use data-c="74" xlink:href="#MJX-TEX-N-74" transform="translate(2225,0)"></use><use data-c="31" xlink:href="#MJX-TEX-N-31" transform="translate(2614,0)"></use><use data-c="47" xlink:href="#MJX-TEX-N-47" transform="translate(3114,0)"></use></g></g><g data-mml-node="mtd" transform="translate(4899,0)"><g data-mml-node="mtext"><use data-c="74" xlink:href="#MJX-TEX-N-74"></use><use data-c="61" xlink:href="#MJX-TEX-N-61" transform="translate(389,0)"></use><use data-c="72" xlink:href="#MJX-TEX-N-72" transform="translate(889,0)"></use><use data-c="67" xlink:href="#MJX-TEX-N-67" transform="translate(1281,0)"></use><use data-c="65" xlink:href="#MJX-TEX-N-65" transform="translate(1781,0)"></use><use data-c="74" xlink:href="#MJX-TEX-N-74" transform="translate(2225,0)"></use><use data-c="32" xlink:href="#MJX-TEX-N-32" transform="translate(2614,0)"></use><use data-c="47" xlink:href="#MJX-TEX-N-47" transform="translate(3114,0)"></use></g></g><g data-mml-node="mtd" transform="translate(9798,0)"><g data-mml-node="mtext"><use data-c="74" xlink:href="#MJX-TEX-N-74"></use><use data-c="61" xlink:href="#MJX-TEX-N-61" transform="translate(389,0)"></use><use data-c="72" xlink:href="#MJX-TEX-N-72" transform="translate(889,0)"></use><use data-c="67" xlink:href="#MJX-TEX-N-67" transform="translate(1281,0)"></use><use data-c="65" xlink:href="#MJX-TEX-N-65" transform="translate(1781,0)"></use><use data-c="74" xlink:href="#MJX-TEX-N-74" transform="translate(2225,0)"></use><use data-c="33" xlink:href="#MJX-TEX-N-33" transform="translate(2614,0)"></use><use data-c="47" xlink:href="#MJX-TEX-N-47" transform="translate(3114,0)"></use></g></g></g><g data-mml-node="mtr" transform="translate(0,-1400)"><g data-mml-node="mtd" transform="translate(38.5,0)"><g data-mml-node="mtext"><use data-c="74" xlink:href="#MJX-TEX-N-74"></use><use data-c="61" xlink:href="#MJX-TEX-N-61" transform="translate(389,0)"></use><use data-c="72" xlink:href="#MJX-TEX-N-72" transform="translate(889,0)"></use><use data-c="67" xlink:href="#MJX-TEX-N-67" transform="translate(1281,0)"></use><use data-c="65" xlink:href="#MJX-TEX-N-65" transform="translate(1781,0)"></use><use data-c="74" xlink:href="#MJX-TEX-N-74" transform="translate(2225,0)"></use><use data-c="31" xlink:href="#MJX-TEX-N-31" transform="translate(2614,0)"></use><use data-c="42" xlink:href="#MJX-TEX-N-42" transform="translate(3114,0)"></use></g></g><g data-mml-node="mtd" transform="translate(4937.5,0)"><g data-mml-node="mtext"><use data-c="74" xlink:href="#MJX-TEX-N-74"></use><use data-c="61" xlink:href="#MJX-TEX-N-61" transform="translate(389,0)"></use><use data-c="72" xlink:href="#MJX-TEX-N-72" transform="translate(889,0)"></use><use data-c="67" xlink:href="#MJX-TEX-N-67" transform="translate(1281,0)"></use><use data-c="65" xlink:href="#MJX-TEX-N-65" transform="translate(1781,0)"></use><use data-c="74" xlink:href="#MJX-TEX-N-74" transform="translate(2225,0)"></use><use data-c="32" xlink:href="#MJX-TEX-N-32" transform="translate(2614,0)"></use><use data-c="42" xlink:href="#MJX-TEX-N-42" transform="translate(3114,0)"></use></g></g><g data-mml-node="mtd" transform="translate(9836.5,0)"><g data-mml-node="mtext"><use data-c="74" xlink:href="#MJX-TEX-N-74"></use><use data-c="61" xlink:href="#MJX-TEX-N-61" transform="translate(389,0)"></use><use data-c="72" xlink:href="#MJX-TEX-N-72" transform="translate(889,0)"></use><use data-c="67" xlink:href="#MJX-TEX-N-67" transform="translate(1281,0)"></use><use data-c="65" xlink:href="#MJX-TEX-N-65" transform="translate(1781,0)"></use><use data-c="74" xlink:href="#MJX-TEX-N-74" transform="translate(2225,0)"></use><use data-c="33" xlink:href="#MJX-TEX-N-33" transform="translate(2614,0)"></use><use data-c="42" xlink:href="#MJX-TEX-N-42" transform="translate(3114,0)"></use></g></g></g></g><g data-mml-node="mo" transform="translate(14364,0)"><use data-c="23A4" xlink:href="#MJX-TEX-S4-23A4" transform="translate(0,996)"></use><use data-c="23A6" xlink:href="#MJX-TEX-S4-23A6" transform="translate(0,-1006)"></use><svg width="667" height="402" y="49" x="0" viewBox="0 100.5 667 402"><use data-c="23A5" xlink:href="#MJX-TEX-S4-23A5" transform="scale(1,1.002)"></use></svg></g></g><g data-mml-node="mo" transform="translate(20623.8,0)"><use data-c="D7" xlink:href="#MJX-TEX-N-D7"></use></g><g data-mml-node="mrow" transform="translate(21624,0)"><g data-mml-node="mo"><use data-c="23A1" xlink:href="#MJX-TEX-S4-23A1" transform="translate(0,996)"></use><use data-c="23A3" xlink:href="#MJX-TEX-S4-23A3" transform="translate(0,-1006)"></use><svg width="667" height="402" y="49" x="0" viewBox="0 100.5 667 402"><use data-c="23A2" xlink:href="#MJX-TEX-S4-23A2" transform="scale(1,1.002)"></use></svg></g><g data-mml-node="mtable" transform="translate(667,0)"><g data-mml-node="mtr" transform="translate(0,1400)"><g data-mml-node="mtd" transform="translate(24.5,0)"><g data-mml-node="mtext"><use data-c="6F" xlink:href="#MJX-TEX-N-6F"></use><use data-c="72" xlink:href="#MJX-TEX-N-72" transform="translate(500,0)"></use><use data-c="69" xlink:href="#MJX-TEX-N-69" transform="translate(892,0)"></use><use data-c="67" xlink:href="#MJX-TEX-N-67" transform="translate(1170,0)"></use><use data-c="69" xlink:href="#MJX-TEX-N-69" transform="translate(1670,0)"></use><use data-c="6E" xlink:href="#MJX-TEX-N-6E" transform="translate(1948,0)"></use><use data-c="61" xlink:href="#MJX-TEX-N-61" transform="translate(2504,0)"></use><use data-c="6C" xlink:href="#MJX-TEX-N-6C" transform="translate(3004,0)"></use><use data-c="52" xlink:href="#MJX-TEX-N-52" transform="translate(3282,0)"></use></g></g></g><g data-mml-node="mtr"><g data-mml-node="mtd"><g data-mml-node="mtext"><use data-c="6F" xlink:href="#MJX-TEX-N-6F"></use><use data-c="72" xlink:href="#MJX-TEX-N-72" transform="translate(500,0)"></use><use data-c="69" xlink:href="#MJX-TEX-N-69" transform="translate(892,0)"></use><use data-c="67" xlink:href="#MJX-TEX-N-67" transform="translate(1170,0)"></use><use data-c="69" xlink:href="#MJX-TEX-N-69" transform="translate(1670,0)"></use><use data-c="6E" xlink:href="#MJX-TEX-N-6E" transform="translate(1948,0)"></use><use data-c="61" xlink:href="#MJX-TEX-N-61" transform="translate(2504,0)"></use><use data-c="6C" xlink:href="#MJX-TEX-N-6C" transform="translate(3004,0)"></use><use data-c="47" xlink:href="#MJX-TEX-N-47" transform="translate(3282,0)"></use></g></g></g><g data-mml-node="mtr" transform="translate(0,-1400)"><g data-mml-node="mtd" transform="translate(38.5,0)"><g data-mml-node="mtext"><use data-c="6F" xlink:href="#MJX-TEX-N-6F"></use><use data-c="72" xlink:href="#MJX-TEX-N-72" transform="translate(500,0)"></use><use data-c="69" xlink:href="#MJX-TEX-N-69" transform="translate(892,0)"></use><use data-c="67" xlink:href="#MJX-TEX-N-67" transform="translate(1170,0)"></use><use data-c="69" xlink:href="#MJX-TEX-N-69" transform="translate(1670,0)"></use><use data-c="6E" xlink:href="#MJX-TEX-N-6E" transform="translate(1948,0)"></use><use data-c="61" xlink:href="#MJX-TEX-N-61" transform="translate(2504,0)"></use><use data-c="6C" xlink:href="#MJX-TEX-N-6C" transform="translate(3004,0)"></use><use data-c="42" xlink:href="#MJX-TEX-N-42" transform="translate(3282,0)"></use></g></g></g></g><g data-mml-node="mo" transform="translate(4734,0)"><use data-c="23A4" xlink:href="#MJX-TEX-S4-23A4" transform="translate(0,996)"></use><use data-c="23A6" xlink:href="#MJX-TEX-S4-23A6" transform="translate(0,-1006)"></use><svg width="667" height="402" y="49" x="0" viewBox="0 100.5 667 402"><use data-c="23A5" xlink:href="#MJX-TEX-S4-23A5" transform="scale(1,1.002)"></use></svg></g></g></g></g></svg><mjx-assistive-mml unselectable="on" display="block"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><mrow data-mjx-texclass="INNER"><mo data-mjx-texclass="OPEN">[</mo><mtable columnspacing="1em" rowspacing="4pt"><mtr><mtd><mtext>finalR</mtext></mtd></mtr><mtr><mtd><mtext>finalG</mtext></mtd></mtr><mtr><mtd><mtext>finalB</mtext></mtd></mtr></mtable><mo data-mjx-texclass="CLOSE">]</mo></mrow><mo>=</mo><mrow data-mjx-texclass="INNER"><mo data-mjx-texclass="OPEN">[</mo><mtable columnspacing="1em" rowspacing="4pt"><mtr><mtd><mtext>target1R</mtext></mtd><mtd><mtext>target2R</mtext></mtd><mtd><mtext>target3R</mtext></mtd></mtr><mtr><mtd><mtext>target1G</mtext></mtd><mtd><mtext>target2G</mtext></mtd><mtd><mtext>target3G</mtext></mtd></mtr><mtr><mtd><mtext>target1B</mtext></mtd><mtd><mtext>target2B</mtext></mtd><mtd><mtext>target3B</mtext></mtd></mtr></mtable><mo data-mjx-texclass="CLOSE">]</mo></mrow><mo>×</mo><mrow data-mjx-texclass="INNER"><mo data-mjx-texclass="OPEN">[</mo><mtable columnspacing="1em" rowspacing="4pt"><mtr><mtd><mtext>originalR</mtext></mtd></mtr><mtr><mtd><mtext>originalG</mtext></mtd></mtr><mtr><mtd><mtext>originalB</mtext></mtd></mtr></mtable><mo data-mjx-texclass="CLOSE">]</mo></mrow></math></mjx-assistive-mml></mjx-container>
</p>
<p>Let's modify our code to use this matrix:</p>
<pre class="language-javascript"><code class="language-javascript"><span class="token keyword">function</span> <span class="token function">replaceImageData</span><span class="token punctuation">(</span><span class="token parameter">imageData<span class="token punctuation">,</span> currentImageData</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token punctuation">[</span>target1R<span class="token punctuation">,</span> target1G<span class="token punctuation">,</span> target1B<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">splitColorToRGB</span><span class="token punctuation">(</span>paleteSelector<span class="token punctuation">.</span>value<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> <span class="token punctuation">[</span>target2R<span class="token punctuation">,</span> target2G<span class="token punctuation">,</span> target2B<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">splitColorToRGB</span><span class="token punctuation">(</span>paleteSelector<span class="token punctuation">.</span>value<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> <span class="token punctuation">[</span>target3R<span class="token punctuation">,</span> target3G<span class="token punctuation">,</span> target3B<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">splitColorToRGB</span><span class="token punctuation">(</span>paleteSelector<span class="token punctuation">.</span>value<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i<span class="token operator">&lt;</span> imageData<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">+=</span><span class="token number">4</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> originalR <span class="token operator">=</span> imageData<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token keyword">const</span> originalG <span class="token operator">=</span> imageData<span class="token punctuation">[</span>i<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token keyword">const</span> originalB <span class="token operator">=</span> imageData<span class="token punctuation">[</span>i<span class="token operator">+</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

        <span class="token comment">// Matrix multiplication</span>
        <span class="token keyword">const</span> finalR <span class="token operator">=</span> target1R <span class="token operator">*</span> originalR <span class="token operator">+</span> target2R <span class="token operator">*</span> originalG <span class="token operator">+</span> target3R <span class="token operator">*</span> originalB<span class="token punctuation">;</span>
        <span class="token keyword">const</span> finalG <span class="token operator">=</span> target1G <span class="token operator">*</span> originalR <span class="token operator">+</span> target2G <span class="token operator">*</span> originalG <span class="token operator">+</span> target3G <span class="token operator">*</span> originalB<span class="token punctuation">;</span>
        <span class="token keyword">const</span> finalB <span class="token operator">=</span> target1B <span class="token operator">*</span> originalR <span class="token operator">+</span> target2B <span class="token operator">*</span> originalG <span class="token operator">+</span> target3B <span class="token operator">*</span> originalB<span class="token punctuation">;</span>

        currentImageData<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">round</span><span class="token punctuation">(</span>finalR<span class="token operator">/</span><span class="token number">255</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        currentImageData<span class="token punctuation">[</span>i<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">round</span><span class="token punctuation">(</span>finalG<span class="token operator">/</span><span class="token number">255</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        currentImageData<span class="token punctuation">[</span>i<span class="token operator">+</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">round</span><span class="token punctuation">(</span>finalB<span class="token operator">/</span><span class="token number">255</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre>
<p>Let's see it in action:</p>
<p><demo-with-playground file="./canvas-color-channel-remapping/index.mjs" initialPath="./canvas-color-channel-remapping/index.html"></demo-with-playground></p>
<p>It works!</p>
<p>Notice that when we select a theme palette with red, green, and blue colors, we get the original image, as expected.</p>
<p>The problem with this approach is that we're processing every pixel in the image, which is very slow.</p>
<p>The complexity is <mjx-container class="MathJax" jax="SVG" style="position: relative;"><svg style="vertical-align: -0.566ex;" xmlns="http://www.w3.org/2000/svg" width="9.175ex" height="2.262ex" role="img" focusable="false" viewBox="0 -750 4055.4 1000" xmlns:xlink="http://www.w3.org/1999/xlink" aria-hidden="true"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mi"><use data-c="1D442" xlink:href="#MJX-TEX-I-1D442"></use></g><g data-mml-node="mo" transform="translate(763,0)"><use data-c="28" xlink:href="#MJX-TEX-N-28"></use></g><g data-mml-node="mi" transform="translate(1152,0)"><use data-c="1D464" xlink:href="#MJX-TEX-I-1D464"></use></g><g data-mml-node="mo" transform="translate(2090.2,0)"><use data-c="D7" xlink:href="#MJX-TEX-N-D7"></use></g><g data-mml-node="mi" transform="translate(3090.4,0)"><use data-c="210E" xlink:href="#MJX-TEX-I-210E"></use></g><g data-mml-node="mo" transform="translate(3666.4,0)"><use data-c="29" xlink:href="#MJX-TEX-N-29"></use></g></g></g></svg><mjx-assistive-mml unselectable="on" display="inline"><math xmlns="http://www.w3.org/1998/Math/MathML"><mi>O</mi><mo stretchy="false">(</mo><mi>w</mi><mo>×</mo><mi>h</mi><mo stretchy="false">)</mo></math></mjx-assistive-mml></mjx-container>, where <mjx-container class="MathJax" jax="SVG" style="position: relative;"><svg style="vertical-align: -0.025ex;" xmlns="http://www.w3.org/2000/svg" width="1.62ex" height="1.027ex" role="img" focusable="false" viewBox="0 -443 716 454" xmlns:xlink="http://www.w3.org/1999/xlink" aria-hidden="true"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mi"><use data-c="1D464" xlink:href="#MJX-TEX-I-1D464"></use></g></g></g></svg><mjx-assistive-mml unselectable="on" display="inline"><math xmlns="http://www.w3.org/1998/Math/MathML"><mi>w</mi></math></mjx-assistive-mml></mjx-container> is the width and <mjx-container class="MathJax" jax="SVG" style="position: relative;"><svg style="vertical-align: -0.025ex;" xmlns="http://www.w3.org/2000/svg" width="1.303ex" height="1.595ex" role="img" focusable="false" viewBox="0 -694 576 705" xmlns:xlink="http://www.w3.org/1999/xlink" aria-hidden="true"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mi"><use data-c="210E" xlink:href="#MJX-TEX-I-210E"></use></g></g></g></svg><mjx-assistive-mml unselectable="on" display="inline"><math xmlns="http://www.w3.org/1998/Math/MathML"><mi>h</mi></math></mjx-assistive-mml></mjx-container> is the height of the image.</p>
<p>For a 1920x1080 image, that's about 2,073,600 operations.</p>
<p>For a 4k image, it's about 8,294,400 operations.</p>
<p>On my MacBook Pro with an M1 Pro processor, it takes about 50ms to process a full HD image, which is not acceptable for real-time video processing.</p>
<p>But matrix multiplication is something the GPU excels at.</p>
<p>We can use WebGL to perform this operation on the GPU.</p>
<p>Actually, the canvas 2D context also uses the GPU, and it has a filter property that performs matrix multiplication under the hood, but it's not very flexible.</p>
<h2>WebGL implementation</h2>
<p>Lets's create a webgl application.
In this article I don't explain how webgl works. The same time, because here we are trying to implement the same feature like for 2d canvas - this can be a good first dive into webgl.</p>
<p>First step is to draw image on a webgl canvas. In case you know webgl - jump here to see the shader code.
If you have never touched webgl you will be impressed how much code it requires to just render an image</p>
<p>We need to add 2 utility functions to simplify our code</p>
<p>Let's instantiate gl code:</p>
<pre class="language-javascript"><code class="language-javascript"><span class="token keyword">const</span> image <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">"image"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> canvas <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">"canvas"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> gl <span class="token operator">=</span> canvas<span class="token punctuation">.</span><span class="token function">getContext</span><span class="token punctuation">(</span><span class="token string">"webgl"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
<pre class="language-javascript"><code class="language-javascript"><span class="token keyword">function</span> <span class="token function">createShader</span><span class="token punctuation">(</span><span class="token parameter">gl<span class="token punctuation">,</span> type<span class="token punctuation">,</span> source</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> shader <span class="token operator">=</span> gl<span class="token punctuation">.</span><span class="token function">createShader</span><span class="token punctuation">(</span>type<span class="token punctuation">)</span><span class="token punctuation">;</span>
  gl<span class="token punctuation">.</span><span class="token function">shaderSource</span><span class="token punctuation">(</span>shader<span class="token punctuation">,</span> source<span class="token punctuation">)</span><span class="token punctuation">;</span>
  gl<span class="token punctuation">.</span><span class="token function">compileShader</span><span class="token punctuation">(</span>shader<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>gl<span class="token punctuation">.</span><span class="token function">getShaderParameter</span><span class="token punctuation">(</span>shader<span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">COMPILE_STATUS</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">"Shader compile failed with: "</span> <span class="token operator">+</span> gl<span class="token punctuation">.</span><span class="token function">getShaderInfoLog</span><span class="token punctuation">(</span>shader<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    gl<span class="token punctuation">.</span><span class="token function">deleteShader</span><span class="token punctuation">(</span>shader<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> shader<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">createProgram</span><span class="token punctuation">(</span><span class="token parameter">gl<span class="token punctuation">,</span> vertexShader<span class="token punctuation">,</span> fragmentShader</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> program <span class="token operator">=</span> gl<span class="token punctuation">.</span><span class="token function">createProgram</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  gl<span class="token punctuation">.</span><span class="token function">attachShader</span><span class="token punctuation">(</span>program<span class="token punctuation">,</span> vertexShader<span class="token punctuation">)</span><span class="token punctuation">;</span>
  gl<span class="token punctuation">.</span><span class="token function">attachShader</span><span class="token punctuation">(</span>program<span class="token punctuation">,</span> fragmentShader<span class="token punctuation">)</span><span class="token punctuation">;</span>
  gl<span class="token punctuation">.</span><span class="token function">linkProgram</span><span class="token punctuation">(</span>program<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>gl<span class="token punctuation">.</span><span class="token function">getProgramParameter</span><span class="token punctuation">(</span>program<span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">LINK_STATUS</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">"Program link failed with: "</span> <span class="token operator">+</span> gl<span class="token punctuation">.</span><span class="token function">getProgramInfoLog</span><span class="token punctuation">(</span>program<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    gl<span class="token punctuation">.</span><span class="token function">deleteProgram</span><span class="token punctuation">(</span>program<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> program<span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre>
<p>vertex shader</p>
<pre class="language-glsl"><code class="language-glsl"><span class="token keyword">attribute</span> <span class="token keyword">vec2</span> a_position<span class="token punctuation">;</span>
<span class="token keyword">attribute</span> <span class="token keyword">vec2</span> a_texCoord<span class="token punctuation">;</span>
<span class="token keyword">varying</span> <span class="token keyword">vec2</span> v_texCoord<span class="token punctuation">;</span>

<span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    gl_Position <span class="token operator">=</span> <span class="token keyword">vec4</span><span class="token punctuation">(</span>a_position<span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">,</span> <span class="token number">1.0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    v_texCoord <span class="token operator">=</span> a_texCoord<span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre>
<p>fragment shader</p>
<pre class="language-glsl"><code class="language-glsl"><span class="token keyword">precision</span> <span class="token keyword">mediump</span> <span class="token keyword">float</span><span class="token punctuation">;</span>
<span class="token keyword">varying</span> <span class="token keyword">vec2</span> v_texCoord<span class="token punctuation">;</span>
<span class="token keyword">uniform</span> <span class="token keyword">sampler2D</span> u_texture<span class="token punctuation">;</span>

<span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    gl_FragColor <span class="token operator">=</span> <span class="token function">texture2D</span><span class="token punctuation">(</span>u_texture<span class="token punctuation">,</span> v_texCoord<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre>
<p>then we can instantiate shaders and</p>
<pre class="language-javascript"><code class="language-javascript"><span class="token keyword">const</span> vertexShader <span class="token operator">=</span> <span class="token function">createShader</span><span class="token punctuation">(</span>gl<span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">VERTEX_SHADER</span><span class="token punctuation">,</span> vertexShaderSrc<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> fragmentShader <span class="token operator">=</span> <span class="token function">createShader</span><span class="token punctuation">(</span>gl<span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">FRAGMENT_SHADER</span><span class="token punctuation">,</span> fragmentShaderSrc<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> program <span class="token operator">=</span> <span class="token function">createProgram</span><span class="token punctuation">(</span>gl<span class="token punctuation">,</span> vertexShader<span class="token punctuation">,</span> fragmentShader<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// Set up rectangle covering the whole canvas</span>
<span class="token keyword">const</span> positions <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Float32Array</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> texCoords <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Float32Array</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> positionBuffer <span class="token operator">=</span> gl<span class="token punctuation">.</span><span class="token function">createBuffer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
gl<span class="token punctuation">.</span><span class="token function">bindBuffer</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">ARRAY_BUFFER</span><span class="token punctuation">,</span> positionBuffer<span class="token punctuation">)</span><span class="token punctuation">;</span>
gl<span class="token punctuation">.</span><span class="token function">bufferData</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">ARRAY_BUFFER</span><span class="token punctuation">,</span> positions<span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">STATIC_DRAW</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> texCoordBuffer <span class="token operator">=</span> gl<span class="token punctuation">.</span><span class="token function">createBuffer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
gl<span class="token punctuation">.</span><span class="token function">bindBuffer</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">ARRAY_BUFFER</span><span class="token punctuation">,</span> texCoordBuffer<span class="token punctuation">)</span><span class="token punctuation">;</span>
gl<span class="token punctuation">.</span><span class="token function">bufferData</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">ARRAY_BUFFER</span><span class="token punctuation">,</span> texCoords<span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">STATIC_DRAW</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

gl<span class="token punctuation">.</span><span class="token function">useProgram</span><span class="token punctuation">(</span>program<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> aPosition <span class="token operator">=</span> gl<span class="token punctuation">.</span><span class="token function">getAttribLocation</span><span class="token punctuation">(</span>program<span class="token punctuation">,</span> <span class="token string">"a_position"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
gl<span class="token punctuation">.</span><span class="token function">enableVertexAttribArray</span><span class="token punctuation">(</span>aPosition<span class="token punctuation">)</span><span class="token punctuation">;</span>
gl<span class="token punctuation">.</span><span class="token function">bindBuffer</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">ARRAY_BUFFER</span><span class="token punctuation">,</span> positionBuffer<span class="token punctuation">)</span><span class="token punctuation">;</span>
gl<span class="token punctuation">.</span><span class="token function">vertexAttribPointer</span><span class="token punctuation">(</span>aPosition<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">FLOAT</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> aTexCoord <span class="token operator">=</span> gl<span class="token punctuation">.</span><span class="token function">getAttribLocation</span><span class="token punctuation">(</span>program<span class="token punctuation">,</span> <span class="token string">"a_texCoord"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
gl<span class="token punctuation">.</span><span class="token function">enableVertexAttribArray</span><span class="token punctuation">(</span>aTexCoord<span class="token punctuation">)</span><span class="token punctuation">;</span>
gl<span class="token punctuation">.</span><span class="token function">bindBuffer</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">ARRAY_BUFFER</span><span class="token punctuation">,</span> texCoordBuffer<span class="token punctuation">)</span><span class="token punctuation">;</span>
gl<span class="token punctuation">.</span><span class="token function">vertexAttribPointer</span><span class="token punctuation">(</span>aTexCoord<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">FLOAT</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
<p>as soon as image loads we can upload texture to webgl</p>
<pre class="language-javascript"><code class="language-javascript"><span class="token keyword">await</span> image<span class="token punctuation">.</span><span class="token function">decode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> texture <span class="token operator">=</span> gl<span class="token punctuation">.</span><span class="token function">createTexture</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
gl<span class="token punctuation">.</span><span class="token function">bindTexture</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">TEXTURE_2D</span><span class="token punctuation">,</span> texture<span class="token punctuation">)</span><span class="token punctuation">;</span>
gl<span class="token punctuation">.</span><span class="token function">texImage2D</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">TEXTURE_2D</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">RGBA</span><span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">RGBA</span><span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">UNSIGNED_BYTE</span><span class="token punctuation">,</span> image<span class="token punctuation">)</span><span class="token punctuation">;</span>

gl<span class="token punctuation">.</span><span class="token function">texParameteri</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">TEXTURE_2D</span><span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">TEXTURE_WRAP_S</span><span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">CLAMP_TO_EDGE</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
gl<span class="token punctuation">.</span><span class="token function">texParameteri</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">TEXTURE_2D</span><span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">TEXTURE_WRAP_T</span><span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">CLAMP_TO_EDGE</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
gl<span class="token punctuation">.</span><span class="token function">texParameteri</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">TEXTURE_2D</span><span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">TEXTURE_MIN_FILTER</span><span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">LINEAR</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
<p>and now we can draw it</p>
<pre class="language-javascript"><code class="language-javascript">gl<span class="token punctuation">.</span><span class="token function">drawArrays</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">TRIANGLE_STRIP</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
<p>Now we can implement color channel map filter.</p>
<p>let's create an abstract filter it will be responsible for applying effects to existing texture.
Such filter will need parameters. Let's create an abstract class</p>
<pre class="language-javascript"><code class="language-javascript"><span class="token keyword">class</span> <span class="token class-name">Filter</span> <span class="token punctuation">{</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">gl<span class="token punctuation">,</span> vertexShaderSource<span class="token punctuation">,</span> fragmentShaderSource</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>gl <span class="token operator">=</span> gl<span class="token punctuation">;</span>
    <span class="token keyword">const</span> vertexShader <span class="token operator">=</span> <span class="token function">createShader</span><span class="token punctuation">(</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>gl<span class="token punctuation">,</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>gl<span class="token punctuation">.</span><span class="token constant">VERTEX_SHADER</span><span class="token punctuation">,</span>
      vertexShaderSource
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> fragmentShader <span class="token operator">=</span> <span class="token function">createShader</span><span class="token punctuation">(</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>gl<span class="token punctuation">,</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>gl<span class="token punctuation">.</span><span class="token constant">FRAGMENT_SHADER</span><span class="token punctuation">,</span>
      fragmentShaderSource
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>program <span class="token operator">=</span> <span class="token function">createProgram</span><span class="token punctuation">(</span>
        gl<span class="token punctuation">,</span>
        vertexShader<span class="token punctuation">,</span>
        fragmentShader<span class="token punctuation">,</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>uniformLocations <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token function">use</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>gl<span class="token punctuation">.</span><span class="token function">useProgram</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>program<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token function">setUniform</span><span class="token punctuation">(</span><span class="token parameter">name<span class="token punctuation">,</span> value</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span>name <span class="token keyword">in</span> <span class="token keyword">this</span><span class="token punctuation">.</span>uniformLocations<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>uniformLocations<span class="token punctuation">[</span>name<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>gl<span class="token punctuation">.</span><span class="token function">getUniformLocation</span><span class="token punctuation">(</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>program<span class="token punctuation">,</span>
        name
      <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">const</span> location <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>uniformLocations<span class="token punctuation">[</span>name<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>location <span class="token operator">===</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      console<span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Uniform </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>name<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> not found in shader.</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>Array<span class="token punctuation">.</span><span class="token function">isArray</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>value<span class="token punctuation">.</span>length <span class="token operator">===</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>gl<span class="token punctuation">.</span><span class="token function">uniform1f</span><span class="token punctuation">(</span>location<span class="token punctuation">,</span> value<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>value<span class="token punctuation">.</span>length <span class="token operator">===</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>gl<span class="token punctuation">.</span><span class="token function">uniform2fv</span><span class="token punctuation">(</span>location<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>value<span class="token punctuation">.</span>length <span class="token operator">===</span> <span class="token number">3</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>gl<span class="token punctuation">.</span><span class="token function">uniform3fv</span><span class="token punctuation">(</span>location<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>value<span class="token punctuation">.</span>length <span class="token operator">===</span> <span class="token number">4</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>gl<span class="token punctuation">.</span><span class="token function">uniform4fv</span><span class="token punctuation">(</span>location<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> value <span class="token operator">===</span> <span class="token string">"number"</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>gl<span class="token punctuation">.</span><span class="token function">uniform1f</span><span class="token punctuation">(</span>location<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> value <span class="token operator">===</span> <span class="token string">"boolean"</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>gl<span class="token punctuation">.</span><span class="token function">uniform1i</span><span class="token punctuation">(</span>location<span class="token punctuation">,</span> value <span class="token operator">?</span> <span class="token number">1</span> <span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">"Unsupported uniform type."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// Ensure the program is being used</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Bind attributes, set uniforms, bind textures, etc. here before drawing</span>
    <span class="token comment">// This will depend on how you've set up your WebGL context outside of this class</span>

    <span class="token comment">// Example: Drawing a quad</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>gl<span class="token punctuation">.</span><span class="token function">drawArrays</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>gl<span class="token punctuation">.</span><span class="token constant">TRIANGLE_STRIP</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre>
<p><a href="webgl-channel-map-filter/image.png"><img src="webgl-channel-map-filter/image.png" alt="image"></a></p>
<p>Now let's</p>
<p>implement a fragment shader. So, basically fragment shader is a programm which executes for every pixels.
It's exactly what we did for 2d canvas iterating through all bytes in uint8Array but it will be running on gpu in parallel.</p>
<p>It's logic consists of 3 steps</p>
<ul>
<li>reading parameters (target colors, we will pass it from javascript)</li>
<li>calculating final color of pixel based on it's current color and logic we will apply</li>
<li>drawing pixel with calculated color</li>
</ul>
<pre class="language-glsl"><code class="language-glsl"><span class="token keyword">precision</span> <span class="token keyword">mediump</span> <span class="token keyword">float</span><span class="token punctuation">;</span>
<span class="token keyword">varying</span> <span class="token keyword">vec2</span> vTextureCoord<span class="token punctuation">;</span>
<span class="token keyword">uniform</span> <span class="token keyword">sampler2D</span> uSampler<span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span> <span class="token directive keyword">read</span> <span class="token expression">params</span></span>
<span class="token keyword">uniform</span> <span class="token keyword">vec3</span> redChannelTargetColor<span class="token punctuation">;</span>
<span class="token keyword">uniform</span> <span class="token keyword">vec3</span> greenChannelTargetColor<span class="token punctuation">;</span>
<span class="token keyword">uniform</span> <span class="token keyword">vec3</span> blueChannelTargetColor<span class="token punctuation">;</span>

<span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">vec4</span> currentColor <span class="token operator">=</span> <span class="token function">texture2D</span><span class="token punctuation">(</span>uSampler<span class="token punctuation">,</span> vTextureCoord<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">float</span> R_s <span class="token operator">=</span> currentColor<span class="token punctuation">.</span>r<span class="token punctuation">;</span>
    <span class="token keyword">float</span> G_s <span class="token operator">=</span> currentColor<span class="token punctuation">.</span>g<span class="token punctuation">;</span>
    <span class="token keyword">float</span> B_s <span class="token operator">=</span> currentColor<span class="token punctuation">.</span>b<span class="token punctuation">;</span>

    <span class="token keyword">float</span> R_t1 <span class="token operator">=</span> redChannelTargetColor<span class="token punctuation">.</span>r<span class="token punctuation">;</span>
    <span class="token keyword">float</span> G_t1 <span class="token operator">=</span> redChannelTargetColor<span class="token punctuation">.</span>g<span class="token punctuation">;</span>
    <span class="token keyword">float</span> B_t1 <span class="token operator">=</span> redChannelTargetColor<span class="token punctuation">.</span>b<span class="token punctuation">;</span>

    <span class="token keyword">float</span> R_t2 <span class="token operator">=</span> greenChannelTargetColor<span class="token punctuation">.</span>r<span class="token punctuation">;</span>
    <span class="token keyword">float</span> G_t2 <span class="token operator">=</span> greenChannelTargetColor<span class="token punctuation">.</span>g<span class="token punctuation">;</span>
    <span class="token keyword">float</span> B_t2 <span class="token operator">=</span> greenChannelTargetColor<span class="token punctuation">.</span>b<span class="token punctuation">;</span>

    <span class="token keyword">float</span> R_t3 <span class="token operator">=</span> blueChannelTargetColor<span class="token punctuation">.</span>r<span class="token punctuation">;</span>
    <span class="token keyword">float</span> G_t3 <span class="token operator">=</span> blueChannelTargetColor<span class="token punctuation">.</span>g<span class="token punctuation">;</span>
    <span class="token keyword">float</span> B_t3 <span class="token operator">=</span> blueChannelTargetColor<span class="token punctuation">.</span>b<span class="token punctuation">;</span>

    <span class="token keyword">float</span> A_f <span class="token operator">=</span> currentColor<span class="token punctuation">.</span>a<span class="token punctuation">;</span>

    <span class="token keyword">float</span> R_f <span class="token operator">=</span> <span class="token punctuation">(</span>R_t1 <span class="token operator">*</span> R_s<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token punctuation">(</span>R_t2 <span class="token operator">*</span> G_s<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token punctuation">(</span>R_t3 <span class="token operator">*</span> B_s<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">float</span> G_f <span class="token operator">=</span> <span class="token punctuation">(</span>G_t1 <span class="token operator">*</span> R_s<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token punctuation">(</span>G_t2 <span class="token operator">*</span> G_s<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token punctuation">(</span>G_t3 <span class="token operator">*</span> B_s<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">float</span> B_f <span class="token operator">=</span> <span class="token punctuation">(</span>B_t1 <span class="token operator">*</span> R_s<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token punctuation">(</span>B_t2 <span class="token operator">*</span> G_s<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token punctuation">(</span>B_t3 <span class="token operator">*</span> B_s<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">vec4</span> col <span class="token operator">=</span> <span class="token keyword">vec4</span><span class="token punctuation">(</span>R_f<span class="token punctuation">,</span> G_f<span class="token punctuation">,</span> B_f<span class="token punctuation">,</span> A_f<span class="token punctuation">)</span><span class="token punctuation">;</span>
    gl_FragColor <span class="token operator">=</span> <span class="token keyword">vec4</span><span class="token punctuation">(</span>col<span class="token punctuation">.</span>rgb <span class="token operator">*</span> col<span class="token punctuation">.</span>a<span class="token punctuation">,</span> col<span class="token punctuation">.</span>a<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre>
<p>now lets create a filter which will use this shader</p>
<pre class="language-javascript"><code class="language-javascript"><span class="token keyword">class</span> <span class="token class-name">ColorChannelMappingFilter</span> <span class="token keyword">extends</span> <span class="token class-name">Filter</span> <span class="token punctuation">{</span>
  <span class="token keyword">static</span> #vertexShaderSource <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">...shader code</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>

  <span class="token keyword">static</span> #fragmentShaderSource <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token template-punctuation string">`</span></span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">gl</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">super</span><span class="token punctuation">(</span>
      gl<span class="token punctuation">,</span>
      ColorChannelMappingFilter<span class="token punctuation">.</span>#vertexShaderSource<span class="token punctuation">,</span>
      ColorChannelMappingFilter<span class="token punctuation">.</span>#fragmentShaderSource
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token function">setRedChannelTargetColor</span><span class="token punctuation">(</span><span class="token parameter">color</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setUniform</span><span class="token punctuation">(</span><span class="token string">"redChannelTargetColor"</span><span class="token punctuation">,</span> color<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token function">setGreenChannelTargetColor</span><span class="token punctuation">(</span><span class="token parameter">color</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setUniform</span><span class="token punctuation">(</span><span class="token string">"greenChannelTargetColor"</span><span class="token punctuation">,</span> color<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token function">setBlueChannelTargetColor</span><span class="token punctuation">(</span><span class="token parameter">color</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setUniform</span><span class="token punctuation">(</span><span class="token string">"blueChannelTargetColor"</span><span class="token punctuation">,</span> color<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre>
<p>now we are read to use it!</p>
<pre class="language-javascript"><code class="language-javascript"><span class="token keyword">const</span> filter <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ColorChannelMappingFilter</span><span class="token punctuation">(</span>gl<span class="token punctuation">)</span><span class="token punctuation">;</span>

filter<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
filter<span class="token punctuation">.</span><span class="token function">setRedChannelTargetColor</span><span class="token punctuation">(</span><span class="token function">hexToVector3</span><span class="token punctuation">(</span><span class="token number">0xe50914</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
filter<span class="token punctuation">.</span><span class="token function">setGreenChannelTargetColor</span><span class="token punctuation">(</span><span class="token function">hexToVector3</span><span class="token punctuation">(</span><span class="token number">0x1877f2</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
filter<span class="token punctuation">.</span><span class="token function">setBlueChannelTargetColor</span><span class="token punctuation">(</span><span class="token function">hexToVector3</span><span class="token punctuation">(</span><span class="token number">0x34a853</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
filter<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
<p><a href="webgl-channel-map-filter/0xe50914_0x1877f2_0x34a853.png"><img src="webgl-channel-map-filter/0xe50914_0x1877f2_0x34a853.png" alt="mapping"></a></p>
<p>let's bind it to our theme selector</p>
<pre class="language-javascript"><code class="language-javascript">paleteSelector<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">"change"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    filter<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    filter<span class="token punctuation">.</span><span class="token function">setRedChannelTargetColor</span><span class="token punctuation">(</span><span class="token function">hexToVector3</span><span class="token punctuation">(</span>paleteSelector<span class="token punctuation">.</span>value<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    filter<span class="token punctuation">.</span><span class="token function">setGreenChannelTargetColor</span><span class="token punctuation">(</span><span class="token function">hexToVector3</span><span class="token punctuation">(</span>paleteSelector<span class="token punctuation">.</span>value<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    filter<span class="token punctuation">.</span><span class="token function">setBlueChannelTargetColor</span><span class="token punctuation">(</span><span class="token function">hexToVector3</span><span class="token punctuation">(</span>paleteSelector<span class="token punctuation">.</span>value<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    filter<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
<p>and now, you can play with theme selector</p>
<p><demo-with-playground file="./webgl-channel-map-filter/index.mjs" initialPath="./webgl-channel-map-filter/index.html"></demo-with-playground></p>
<p>Now, let's apply this filter to a video.</p>
<p>Firstly, we need to initialize video</p>
<pre class="language-html"><code class="language-html"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>video</span>
   <span class="token special-attr"><span class="token attr-name">style</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span><span class="token value css language-css"><span class="token property">width</span><span class="token punctuation">:</span> 50%<span class="token punctuation">;</span></span><span class="token punctuation">"</span></span></span>
   <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>video<span class="token punctuation">"</span></span>
   <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>https://media.githubusercontent.com/media/stepancar/articles/main/articles/color-channel-mapping/webgl-channel-map-filter/video/video2.mp4<span class="token punctuation">"</span></span>
   <span class="token attr-name">crossorigin</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>anonymous<span class="token punctuation">"</span></span>
   <span class="token attr-name">loop</span> <span class="token attr-name">autoplay</span> <span class="token attr-name">muted</span>
<span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>video</span><span class="token punctuation">&gt;</span></span></code></pre>
<p>then, you need to modify render so it would update texture with video frame
and it should be called every frame:</p>
<pre class="language-javascript"><code class="language-javascript"><span class="token keyword">function</span> <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  gl<span class="token punctuation">.</span><span class="token function">bindTexture</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">TEXTURE_2D</span><span class="token punctuation">,</span> texture<span class="token punctuation">)</span><span class="token punctuation">;</span>
  gl<span class="token punctuation">.</span><span class="token function">texImage2D</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">TEXTURE_2D</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">RGBA</span><span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">RGBA</span><span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">UNSIGNED_BYTE</span><span class="token punctuation">,</span> video<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// pass htmlVideoElement</span>

  gl<span class="token punctuation">.</span><span class="token function">texParameteri</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">TEXTURE_2D</span><span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">TEXTURE_WRAP_S</span><span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">CLAMP_TO_EDGE</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  gl<span class="token punctuation">.</span><span class="token function">texParameteri</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">TEXTURE_2D</span><span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">TEXTURE_WRAP_T</span><span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">CLAMP_TO_EDGE</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  gl<span class="token punctuation">.</span><span class="token function">texParameteri</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">TEXTURE_2D</span><span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">TEXTURE_MIN_FILTER</span><span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">LINEAR</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  gl<span class="token punctuation">.</span><span class="token function">drawArrays</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">TRIANGLE_STRIP</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  filter<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  filter<span class="token punctuation">.</span><span class="token function">setRedChannelTargetColor</span><span class="token punctuation">(</span><span class="token function">hexToVector3</span><span class="token punctuation">(</span>paleteSelector<span class="token punctuation">.</span>value<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  filter<span class="token punctuation">.</span><span class="token function">setGreenChannelTargetColor</span><span class="token punctuation">(</span><span class="token function">hexToVector3</span><span class="token punctuation">(</span>paleteSelector<span class="token punctuation">.</span>value<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  filter<span class="token punctuation">.</span><span class="token function">setBlueChannelTargetColor</span><span class="token punctuation">(</span><span class="token function">hexToVector3</span><span class="token punctuation">(</span>paleteSelector<span class="token punctuation">.</span>value<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  filter<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token function">requestAnimationFrame</span><span class="token punctuation">(</span>render<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
<p>Here is the final result:</p>
<p><demo-with-playground file="./webgl-channel-map-filter/video/index.mjs" initialPath="./webgl-channel-map-filter/video/index.html"></demo-with-playground></p>
<h2>Svg filter on Canvas</h2>
<p>We can express the same logic using SVG filters. This is a more declarative way to express the same logic.</p>
<pre class="language-xml"><code class="language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>svg</span>
    <span class="token attr-name">version</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>1.1<span class="token punctuation">"</span></span>
    <span class="token attr-name">xmlns</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>http://www.w3.org/2000/svg<span class="token punctuation">"</span></span>
    <span class="token attr-name"><span class="token namespace">xmlns:</span>xlink</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>http://www.w3.org/1999/xlink<span class="token punctuation">"</span></span>
    <span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>defs</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>filter</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>colorChannelMapFilter<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>feColorMatrix</span>
                <span class="token attr-name">in</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>SourceGraphic<span class="token punctuation">"</span></span>
                <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>matrix<span class="token punctuation">"</span></span>
                <span class="token attr-name">values</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>
                    0 1 0 0 0 
                    1 0 0 0 0 
                    1 0 0 0 0 
                    0 0 0 1 0<span class="token punctuation">"</span></span>
                <span class="token punctuation">/&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>filter</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>defs</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>svg</span><span class="token punctuation">&gt;</span></span></code></pre>
<p>When we select new theme, we can update the filter values:</p>
<pre class="language-javascript"><code class="language-javascript"><span class="token keyword">function</span> <span class="token function">replaceColors</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> feColorMatrix <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span><span class="token string">'#colorChannelMapFilter feColorMatrix'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> <span class="token punctuation">[</span>target1R<span class="token punctuation">,</span> target1G<span class="token punctuation">,</span> target1B<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">splitColorToRGB</span><span class="token punctuation">(</span>paleteSelector<span class="token punctuation">.</span>value<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> <span class="token punctuation">[</span>target2R<span class="token punctuation">,</span> target2G<span class="token punctuation">,</span> target2B<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">splitColorToRGB</span><span class="token punctuation">(</span>paleteSelector<span class="token punctuation">.</span>value<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> <span class="token punctuation">[</span>target3R<span class="token punctuation">,</span> target3G<span class="token punctuation">,</span> target3B<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">splitColorToRGB</span><span class="token punctuation">(</span>paleteSelector<span class="token punctuation">.</span>value<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> filterValues <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">
        </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>target1R<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>target2R<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>target3R<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> 0 0
        </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>target1G<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>target2G<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>target3G<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> 0 0
        </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>target1B<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>target2B<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>target3B<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> 0 0
        0 0 0 1 0
    </span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>

    feColorMatrix<span class="token punctuation">.</span><span class="token function">setAttribute</span><span class="token punctuation">(</span><span class="token string">'values'</span><span class="token punctuation">,</span> filterValues<span class="token punctuation">)</span><span class="token punctuation">;</span>
    ctx<span class="token punctuation">.</span>filter <span class="token operator">=</span> <span class="token string">"url(#colorChannelMapFilter)"</span><span class="token punctuation">;</span>
    ctx<span class="token punctuation">.</span><span class="token function">drawImage</span><span class="token punctuation">(</span>image<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre>
<p><demo-with-playground file="./canvas-svg-filter-color-channel-remapping/index.html" initialPath="./canvas-svg-filter-color-channel-remapping/index.html"></demo-with-playground></p>
<script src="index.mjs" type="module"></script>
          </div>
        </article>
      </main>
      <footer></footer>
    </layout>

    <script>
        function resizeIframe(iframe) {
            const height = parseInt(iframe.style.height);
            const scrollHeight = iframe.contentWindow.document.documentElement.scrollHeight
            iframe.style.height = scrollHeight + 'px';
            console.log(height, scrollHeight)
            if (height < scrollHeight) {  
              console.log('resize')
              iframe.style.height = scrollHeight + 20 + 'px';
            }
        }

        setInterval(() => {
            const iframes = document.querySelectorAll('iframe');
            iframes.forEach((iframe) => {
              resizeIframe(iframe);
            });
        }, 100);


    class DemoWithPlayground extends HTMLElement {
      static get observedAttributes() {
        return ['initialPath', 'file'];
      }

      constructor() {
          super();
              // this.attachShadow({ mode: 'open' });
          }

          connectedCallback() {
              this.render();
          }

          attributeChangedCallback() {
              this.render();
          }

          render() {
              const initialPath = this.getAttribute('initialPath') || '';
              const file = this.getAttribute('file') || '';
          
          this.innerHTML = `
          <div>
              <iframe src="./${initialPath}"></iframe>

              <a href="https://stackblitz.com/github/stepancar/articles/tree/main/articles/apply-LUT-to-canvas/?file=${file}&initialPath=${initialPath}&startScript=start" target="_blank">
              <img
                  alt="Open in StackBlitz"
                  src="https://developer.stackblitz.com/img/open_in_stackblitz.svg"
              />
              </a>
          </div>
          `;
          }
      }

    customElements.define('demo-with-playground', DemoWithPlayground);
    </script>
  <svg style="display: none;" id="MJX-SVG-global-cache"><defs><path id="MJX-TEX-S4-23A1" d="M319 -645V1154H666V1070H403V-645H319Z"></path><path id="MJX-TEX-S4-23A3" d="M319 -644V1155H403V-560H666V-644H319Z"></path><path id="MJX-TEX-S4-23A2" d="M319 0V602H403V0H319Z"></path><path id="MJX-TEX-N-66" d="M273 0Q255 3 146 3Q43 3 34 0H26V46H42Q70 46 91 49Q99 52 103 60Q104 62 104 224V385H33V431H104V497L105 564L107 574Q126 639 171 668T266 704Q267 704 275 704T289 705Q330 702 351 679T372 627Q372 604 358 590T321 576T284 590T270 627Q270 647 288 667H284Q280 668 273 668Q245 668 223 647T189 592Q183 572 182 497V431H293V385H185V225Q185 63 186 61T189 57T194 54T199 51T206 49T213 48T222 47T231 47T241 46T251 46H282V0H273Z"></path><path id="MJX-TEX-N-69" d="M69 609Q69 637 87 653T131 669Q154 667 171 652T188 609Q188 579 171 564T129 549Q104 549 87 564T69 609ZM247 0Q232 3 143 3Q132 3 106 3T56 1L34 0H26V46H42Q70 46 91 49Q100 53 102 60T104 102V205V293Q104 345 102 359T88 378Q74 385 41 385H30V408Q30 431 32 431L42 432Q52 433 70 434T106 436Q123 437 142 438T171 441T182 442H185V62Q190 52 197 50T232 46H255V0H247Z"></path><path id="MJX-TEX-N-6E" d="M41 46H55Q94 46 102 60V68Q102 77 102 91T102 122T103 161T103 203Q103 234 103 269T102 328V351Q99 370 88 376T43 385H25V408Q25 431 27 431L37 432Q47 433 65 434T102 436Q119 437 138 438T167 441T178 442H181V402Q181 364 182 364T187 369T199 384T218 402T247 421T285 437Q305 442 336 442Q450 438 463 329Q464 322 464 190V104Q464 66 466 59T477 49Q498 46 526 46H542V0H534L510 1Q487 2 460 2T422 3Q319 3 310 0H302V46H318Q379 46 379 62Q380 64 380 200Q379 335 378 343Q372 371 358 385T334 402T308 404Q263 404 229 370Q202 343 195 315T187 232V168V108Q187 78 188 68T191 55T200 49Q221 46 249 46H265V0H257L234 1Q210 2 183 2T145 3Q42 3 33 0H25V46H41Z"></path><path id="MJX-TEX-N-61" d="M137 305T115 305T78 320T63 359Q63 394 97 421T218 448Q291 448 336 416T396 340Q401 326 401 309T402 194V124Q402 76 407 58T428 40Q443 40 448 56T453 109V145H493V106Q492 66 490 59Q481 29 455 12T400 -6T353 12T329 54V58L327 55Q325 52 322 49T314 40T302 29T287 17T269 6T247 -2T221 -8T190 -11Q130 -11 82 20T34 107Q34 128 41 147T68 188T116 225T194 253T304 268H318V290Q318 324 312 340Q290 411 215 411Q197 411 181 410T156 406T148 403Q170 388 170 359Q170 334 154 320ZM126 106Q126 75 150 51T209 26Q247 26 276 49T315 109Q317 116 318 175Q318 233 317 233Q309 233 296 232T251 223T193 203T147 166T126 106Z"></path><path id="MJX-TEX-N-6C" d="M42 46H56Q95 46 103 60V68Q103 77 103 91T103 124T104 167T104 217T104 272T104 329Q104 366 104 407T104 482T104 542T103 586T103 603Q100 622 89 628T44 637H26V660Q26 683 28 683L38 684Q48 685 67 686T104 688Q121 689 141 690T171 693T182 694H185V379Q185 62 186 60Q190 52 198 49Q219 46 247 46H263V0H255L232 1Q209 2 183 2T145 3T107 3T57 1L34 0H26V46H42Z"></path><path id="MJX-TEX-N-52" d="M130 622Q123 629 119 631T103 634T60 637H27V683H202H236H300Q376 683 417 677T500 648Q595 600 609 517Q610 512 610 501Q610 468 594 439T556 392T511 361T472 343L456 338Q459 335 467 332Q497 316 516 298T545 254T559 211T568 155T578 94Q588 46 602 31T640 16H645Q660 16 674 32T692 87Q692 98 696 101T712 105T728 103T732 90Q732 59 716 27T672 -16Q656 -22 630 -22Q481 -16 458 90Q456 101 456 163T449 246Q430 304 373 320L363 322L297 323H231V192L232 61Q238 51 249 49T301 46H334V0H323Q302 3 181 3Q59 3 38 0H27V46H60Q102 47 111 49T130 61V622ZM491 499V509Q491 527 490 539T481 570T462 601T424 623T362 636Q360 636 340 636T304 637H283Q238 637 234 628Q231 624 231 492V360H289Q390 360 434 378T489 456Q491 467 491 499Z"></path><path id="MJX-TEX-N-47" d="M56 342Q56 428 89 500T174 615T283 681T391 705Q394 705 400 705T408 704Q499 704 569 636L582 624L612 663Q639 700 643 704Q644 704 647 704T653 705H657Q660 705 666 699V419L660 413H626Q620 419 619 430Q610 512 571 572T476 651Q457 658 426 658Q401 658 376 654T316 633T254 592T205 519T177 411Q173 369 173 335Q173 259 192 201T238 111T302 58T370 31T431 24Q478 24 513 45T559 100Q562 110 562 160V212Q561 213 557 216T551 220T542 223T526 225T502 226T463 227H437V273H449L609 270Q715 270 727 273H735V227H721Q674 227 668 215Q666 211 666 108V6Q660 0 657 0Q653 0 639 10Q617 25 600 42L587 54Q571 27 524 3T406 -22Q317 -22 238 22T108 151T56 342Z"></path><path id="MJX-TEX-N-42" d="M131 622Q124 629 120 631T104 634T61 637H28V683H229H267H346Q423 683 459 678T531 651Q574 627 599 590T624 512Q624 461 583 419T476 360L466 357Q539 348 595 302T651 187Q651 119 600 67T469 3Q456 1 242 0H28V46H61Q103 47 112 49T131 61V622ZM511 513Q511 560 485 594T416 636Q415 636 403 636T371 636T333 637Q266 637 251 636T232 628Q229 624 229 499V374H312L396 375L406 377Q410 378 417 380T442 393T474 417T499 456T511 513ZM537 188Q537 239 509 282T430 336L329 337H229V200V116Q229 57 234 52Q240 47 334 47H383Q425 47 443 53Q486 67 511 104T537 188Z"></path><path id="MJX-TEX-S4-23A4" d="M0 1070V1154H347V-645H263V1070H0Z"></path><path id="MJX-TEX-S4-23A6" d="M263 -560V1155H347V-644H0V-560H263Z"></path><path id="MJX-TEX-S4-23A5" d="M263 0V602H347V0H263Z"></path><path id="MJX-TEX-N-3D" d="M56 347Q56 360 70 367H707Q722 359 722 347Q722 336 708 328L390 327H72Q56 332 56 347ZM56 153Q56 168 72 173H708Q722 163 722 153Q722 140 707 133H70Q56 140 56 153Z"></path><path id="MJX-TEX-N-74" d="M27 422Q80 426 109 478T141 600V615H181V431H316V385H181V241Q182 116 182 100T189 68Q203 29 238 29Q282 29 292 100Q293 108 293 146V181H333V146V134Q333 57 291 17Q264 -10 221 -10Q187 -10 162 2T124 33T105 68T98 100Q97 107 97 248V385H18V422H27Z"></path><path id="MJX-TEX-N-72" d="M36 46H50Q89 46 97 60V68Q97 77 97 91T98 122T98 161T98 203Q98 234 98 269T98 328L97 351Q94 370 83 376T38 385H20V408Q20 431 22 431L32 432Q42 433 60 434T96 436Q112 437 131 438T160 441T171 442H174V373Q213 441 271 441H277Q322 441 343 419T364 373Q364 352 351 337T313 322Q288 322 276 338T263 372Q263 381 265 388T270 400T273 405Q271 407 250 401Q234 393 226 386Q179 341 179 207V154Q179 141 179 127T179 101T180 81T180 66V61Q181 59 183 57T188 54T193 51T200 49T207 48T216 47T225 47T235 46T245 46H276V0H267Q249 3 140 3Q37 3 28 0H20V46H36Z"></path><path id="MJX-TEX-N-67" d="M329 409Q373 453 429 453Q459 453 472 434T485 396Q485 382 476 371T449 360Q416 360 412 390Q410 404 415 411Q415 412 416 414V415Q388 412 363 393Q355 388 355 386Q355 385 359 381T368 369T379 351T388 325T392 292Q392 230 343 187T222 143Q172 143 123 171Q112 153 112 133Q112 98 138 81Q147 75 155 75T227 73Q311 72 335 67Q396 58 431 26Q470 -13 470 -72Q470 -139 392 -175Q332 -206 250 -206Q167 -206 107 -175Q29 -140 29 -75Q29 -39 50 -15T92 18L103 24Q67 55 67 108Q67 155 96 193Q52 237 52 292Q52 355 102 398T223 442Q274 442 318 416L329 409ZM299 343Q294 371 273 387T221 404Q192 404 171 388T145 343Q142 326 142 292Q142 248 149 227T179 192Q196 182 222 182Q244 182 260 189T283 207T294 227T299 242Q302 258 302 292T299 343ZM403 -75Q403 -50 389 -34T348 -11T299 -2T245 0H218Q151 0 138 -6Q118 -15 107 -34T95 -74Q95 -84 101 -97T122 -127T170 -155T250 -167Q319 -167 361 -139T403 -75Z"></path><path id="MJX-TEX-N-65" d="M28 218Q28 273 48 318T98 391T163 433T229 448Q282 448 320 430T378 380T406 316T415 245Q415 238 408 231H126V216Q126 68 226 36Q246 30 270 30Q312 30 342 62Q359 79 369 104L379 128Q382 131 395 131H398Q415 131 415 121Q415 117 412 108Q393 53 349 21T250 -11Q155 -11 92 58T28 218ZM333 275Q322 403 238 411H236Q228 411 220 410T195 402T166 381T143 340T127 274V267H333V275Z"></path><path id="MJX-TEX-N-31" d="M213 578L200 573Q186 568 160 563T102 556H83V602H102Q149 604 189 617T245 641T273 663Q275 666 285 666Q294 666 302 660V361L303 61Q310 54 315 52T339 48T401 46H427V0H416Q395 3 257 3Q121 3 100 0H88V46H114Q136 46 152 46T177 47T193 50T201 52T207 57T213 61V578Z"></path><path id="MJX-TEX-N-32" d="M109 429Q82 429 66 447T50 491Q50 562 103 614T235 666Q326 666 387 610T449 465Q449 422 429 383T381 315T301 241Q265 210 201 149L142 93L218 92Q375 92 385 97Q392 99 409 186V189H449V186Q448 183 436 95T421 3V0H50V19V31Q50 38 56 46T86 81Q115 113 136 137Q145 147 170 174T204 211T233 244T261 278T284 308T305 340T320 369T333 401T340 431T343 464Q343 527 309 573T212 619Q179 619 154 602T119 569T109 550Q109 549 114 549Q132 549 151 535T170 489Q170 464 154 447T109 429Z"></path><path id="MJX-TEX-N-33" d="M127 463Q100 463 85 480T69 524Q69 579 117 622T233 665Q268 665 277 664Q351 652 390 611T430 522Q430 470 396 421T302 350L299 348Q299 347 308 345T337 336T375 315Q457 262 457 175Q457 96 395 37T238 -22Q158 -22 100 21T42 130Q42 158 60 175T105 193Q133 193 151 175T169 130Q169 119 166 110T159 94T148 82T136 74T126 70T118 67L114 66Q165 21 238 21Q293 21 321 74Q338 107 338 175V195Q338 290 274 322Q259 328 213 329L171 330L168 332Q166 335 166 348Q166 366 174 366Q202 366 232 371Q266 376 294 413T322 525V533Q322 590 287 612Q265 626 240 626Q208 626 181 615T143 592T132 580H135Q138 579 143 578T153 573T165 566T175 555T183 540T186 520Q186 498 172 481T127 463Z"></path><path id="MJX-TEX-N-D7" d="M630 29Q630 9 609 9Q604 9 587 25T493 118L389 222L284 117Q178 13 175 11Q171 9 168 9Q160 9 154 15T147 29Q147 36 161 51T255 146L359 250L255 354Q174 435 161 449T147 471Q147 480 153 485T168 490Q173 490 175 489Q178 487 284 383L389 278L493 382Q570 459 587 475T609 491Q630 491 630 471Q630 464 620 453T522 355L418 250L522 145Q606 61 618 48T630 29Z"></path><path id="MJX-TEX-N-6F" d="M28 214Q28 309 93 378T250 448Q340 448 405 380T471 215Q471 120 407 55T250 -10Q153 -10 91 57T28 214ZM250 30Q372 30 372 193V225V250Q372 272 371 288T364 326T348 362T317 390T268 410Q263 411 252 411Q222 411 195 399Q152 377 139 338T126 246V226Q126 130 145 91Q177 30 250 30Z"></path><path id="MJX-TEX-I-1D442" d="M740 435Q740 320 676 213T511 42T304 -22Q207 -22 138 35T51 201Q50 209 50 244Q50 346 98 438T227 601Q351 704 476 704Q514 704 524 703Q621 689 680 617T740 435ZM637 476Q637 565 591 615T476 665Q396 665 322 605Q242 542 200 428T157 216Q157 126 200 73T314 19Q404 19 485 98T608 313Q637 408 637 476Z"></path><path id="MJX-TEX-N-28" d="M94 250Q94 319 104 381T127 488T164 576T202 643T244 695T277 729T302 750H315H319Q333 750 333 741Q333 738 316 720T275 667T226 581T184 443T167 250T184 58T225 -81T274 -167T316 -220T333 -241Q333 -250 318 -250H315H302L274 -226Q180 -141 137 -14T94 250Z"></path><path id="MJX-TEX-I-1D464" d="M580 385Q580 406 599 424T641 443Q659 443 674 425T690 368Q690 339 671 253Q656 197 644 161T609 80T554 12T482 -11Q438 -11 404 5T355 48Q354 47 352 44Q311 -11 252 -11Q226 -11 202 -5T155 14T118 53T104 116Q104 170 138 262T173 379Q173 380 173 381Q173 390 173 393T169 400T158 404H154Q131 404 112 385T82 344T65 302T57 280Q55 278 41 278H27Q21 284 21 287Q21 293 29 315T52 366T96 418T161 441Q204 441 227 416T250 358Q250 340 217 250T184 111Q184 65 205 46T258 26Q301 26 334 87L339 96V119Q339 122 339 128T340 136T341 143T342 152T345 165T348 182T354 206T362 238T373 281Q402 395 406 404Q419 431 449 431Q468 431 475 421T483 402Q483 389 454 274T422 142Q420 131 420 107V100Q420 85 423 71T442 42T487 26Q558 26 600 148Q609 171 620 213T632 273Q632 306 619 325T593 357T580 385Z"></path><path id="MJX-TEX-I-210E" d="M137 683Q138 683 209 688T282 694Q294 694 294 685Q294 674 258 534Q220 386 220 383Q220 381 227 388Q288 442 357 442Q411 442 444 415T478 336Q478 285 440 178T402 50Q403 36 407 31T422 26Q450 26 474 56T513 138Q516 149 519 151T535 153Q555 153 555 145Q555 144 551 130Q535 71 500 33Q466 -10 419 -10H414Q367 -10 346 17T325 74Q325 90 361 192T398 345Q398 404 354 404H349Q266 404 205 306L198 293L164 158Q132 28 127 16Q114 -11 83 -11Q69 -11 59 -2T48 16Q48 30 121 320L195 616Q195 629 188 632T149 637H128Q122 643 122 645T124 664Q129 683 137 683Z"></path><path id="MJX-TEX-N-29" d="M60 749L64 750Q69 750 74 750H86L114 726Q208 641 251 514T294 250Q294 182 284 119T261 12T224 -76T186 -143T145 -194T113 -227T90 -246Q87 -249 86 -250H74Q66 -250 63 -250T58 -247T55 -238Q56 -237 66 -225Q221 -64 221 250T66 725Q56 737 55 738Q55 746 60 749Z"></path></defs></svg></body>
</html>
