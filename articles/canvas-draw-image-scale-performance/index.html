<!DOCTYPE >
<html>
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Scale performance of drawImage</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/default.min.css">
    <link rel="preconnect" href="https://fonts.gstatic.com">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+KR:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/articles/styles/highlight.css">
    <link rel="stylesheet" href="/articles/styles/header.css">
    <link rel="stylesheet" href="/articles/styles/content.css">
    <link rel="stylesheet" href="/articles/styles/markdown.css">
    <style rel="stylesheet">
      mjx-container[jax="SVG"] > svg {
         max-width: 100%;
      }
    </style>
    <link rel="stylesheet" href="/articles/styles/typography.css">
    
  </head>

  <body>
    <layout>
      <header>
        <h1>
          Scale performance of drawImage
        </h1>
      </header>
      <main>
        <article class="markdown">
          <h2 class="shortDescription">This article validates the performance of drawImage when scaling images</h2>
          <div class="content">
            <h1>Scale performance of drawImage</h1>
<h2>Introductions</h2>
<p>This article explores <a href="https://developer.mozilla.org/en-US/docs/Web/API/Canvas_API/Tutorial/Optimizing_canvas#dont_scale_images_in_drawimage">recommendation from mdn</a> about image scaling by the CanvasRenderingContext2D.drawImage().</p>
<blockquote>
<p>Don't scale images in drawImage</p>
</blockquote>
<p>We ran tests with dynamic image scaling versus drawing without scaling.</p>
<p>Spoiler: <em>in all cases there is either minimal or no difference</em>.</p>
<h2>Methodological research</h2>
<p>We used JS in conjunction with HTML so we could test the theory on our inputs:</p>
<ul>
<li>URL of an image</li>
<li>count of iterations</li>
<li>height of the canvas</li>
<li>width of the canvas</li>
<li><a href="https://developer.mozilla.org/en-US/docs/Web/API/CanvasRenderingContext2D/imageSmoothingQuality">imageSmoothingQuality</a></li>
<li>Random scale range</li>
</ul>
<pre class="language-js"><code class="language-js"><span class="token keyword">function</span> <span class="token function">drawImageWithoutScale</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> start <span class="token operator">=</span> performance<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> iterationsCount<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> x <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">random</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> canvas1<span class="token punctuation">.</span>width<span class="token punctuation">;</span>
        <span class="token keyword">const</span> y <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">random</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> canvas1<span class="token punctuation">.</span>height<span class="token punctuation">;</span>
        ctx2<span class="token punctuation">.</span><span class="token function">drawImage</span><span class="token punctuation">(</span>image<span class="token punctuation">,</span> x<span class="token punctuation">,</span> y<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">const</span> end <span class="token operator">=</span> performance<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> end <span class="token operator">-</span> start<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">drawImageWithScale</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> start <span class="token operator">=</span> performance<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> iterationsCount<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">let</span> x <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">random</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> canvas1<span class="token punctuation">.</span>width<span class="token punctuation">;</span>
        <span class="token keyword">let</span> y <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">random</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> canvas1<span class="token punctuation">.</span>height<span class="token punctuation">;</span>
        <span class="token keyword">let</span> scaleParameter <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">random</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token punctuation">(</span>rangeTo <span class="token operator">-</span> rangeFrom<span class="token punctuation">)</span> <span class="token operator">+</span> rangeFrom<span class="token punctuation">;</span>
        ctx1<span class="token punctuation">.</span><span class="token function">resetTransform</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        ctx1<span class="token punctuation">.</span><span class="token function">scale</span><span class="token punctuation">(</span>scaleParameter<span class="token punctuation">,</span> scaleParameter<span class="token punctuation">)</span><span class="token punctuation">;</span>
        ctx1<span class="token punctuation">.</span><span class="token function">drawImage</span><span class="token punctuation">(</span>image<span class="token punctuation">,</span> x<span class="token punctuation">,</span> y<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">const</span> end <span class="token operator">=</span> performance<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> time <span class="token operator">=</span> end <span class="token operator">-</span> start<span class="token punctuation">;</span>
    <span class="token keyword">return</span> time<span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre>
<p>The rendering with and without scaling in two different canvases is run according to the specified parameters, the time measurements are displayed in a table.</p>
<p>Example:
<img src="image.png" alt="table"></p>
<p>You can take measurements with your values</p>
<p><demo-with-playground file="scale/index.html" initialPath="./scale/index.html"></demo-with-playground></p>
<h2>Measurement results</h2>
<table>
<thead>
<tr>
<th>#</th>
<th>filename</th>
<th>iterations</th>
<th>canvas size</th>
<th>smoothing quality</th>
<th>image size</th>
<th>scale</th>
<th>drawImage without scale</th>
<th>drawImage with scale</th>
</tr>
</thead>
<tbody>
<tr>
<td>1</td>
<td>Lenna.png</td>
<td>330x330</td>
<td>[0.9;1.1)</td>
<td>10000</td>
<td>1920x1080</td>
<td>low</td>
<td>31.1</td>
<td>50</td>
</tr>
<tr>
<td>2</td>
<td>Lenna.png</td>
<td>330x330</td>
<td>[0.9;1.1)</td>
<td>10000</td>
<td>1920x1080</td>
<td>low</td>
<td>23.39</td>
<td>46.8</td>
</tr>
</tbody>
</table>
<h2>Analyzing measurement results</h2>
<ul>
<li>
<p>The difference in time is noticeable only at 1000+ iterations.</p>
</li>
<li>
<p>No significant performance slippages were detected with scale().</p>
</li>
<li>
<p>When using modern browsers, engine-level optimization probably smoothes out the differences.</p>
</li>
</ul>
<h2>Conclusion</h2>
<p>The mdn recommendation that using scale() is a slow operation can be considered outdated and irrelevant, since in the current realities the GPU speeds up such calculations.
The above synthetic measurements for 1000+ iterations may show a slight increase in time when using scaling, but under normal conditions this difference will be completely unnoticeable and will not affect the user experience.</p>
<!-- указать ссылку на код -->
<a href="." target="_blank">
  <img alt="Open in StackBlitz" src="https://developer.stackblitz.com/img/open_in_stackblitz.svg">
</a>
          </div>
        </article>
      </main>
      <footer></footer>
    </layout>

    <script>
        function resizeIframe(iframe) {
            const height = parseInt(iframe.style.height);
            const scrollHeight = iframe.contentWindow.document.documentElement.scrollHeight
            iframe.style.height = scrollHeight + 'px';
            console.log(height, scrollHeight)
            if (height < scrollHeight) {  
              console.log('resize')
              iframe.style.height = scrollHeight + 20 + 'px';
            }
        }

        setInterval(() => {
            const iframes = document.querySelectorAll('iframe');
            iframes.forEach((iframe) => {
              resizeIframe(iframe);
            });
        }, 100);


    class DemoWithPlayground extends HTMLElement {
      static get observedAttributes() {
        return ['initialPath', 'file'];
      }

      constructor() {
          super();
              // this.attachShadow({ mode: 'open' });
          }

          connectedCallback() {
              this.render();
          }

          attributeChangedCallback() {
              this.render();
          }

          render() {
              const initialPath = this.getAttribute('initialPath') || '';
              const file = this.getAttribute('file') || '';
          
          this.innerHTML = `
          <div>
              <iframe src="./${initialPath}"></iframe>

              <a href="https://stackblitz.com/github/stepancar/articles/tree/main/articles/canvas-draw-image-scale-performance/?file=${file}&initialPath=${initialPath}&startScript=start" target="_blank">
              <img
                  alt="Open in StackBlitz"
                  src="https://developer.stackblitz.com/img/open_in_stackblitz.svg"
              />
              </a>
          </div>
          `;
          }
      }

    customElements.define('demo-with-playground', DemoWithPlayground);
    </script>
  </body>
</html>
