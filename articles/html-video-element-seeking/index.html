<!DOCTYPE >
<html>
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>HTML Video Element Seeking Performance</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/default.min.css">
    <link rel="preconnect" href="https://fonts.gstatic.com">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+KR:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/articles/styles/highlight.css">
    <link rel="stylesheet" href="/articles/styles/header.css">
    <link rel="stylesheet" href="/articles/styles/content.css">
    <link rel="stylesheet" href="/articles/styles/markdown.css">
    <style rel="stylesheet">
      mjx-container[jax="SVG"] > svg {
         max-width: 100%;
      }
    </style>
    <link rel="stylesheet" href="/articles/styles/typography.css">
    
  </head>

  <body>
    <layout>
      <header>
        <h1>
          HTML Video Element Seeking Performance
        </h1>
      </header>
      <main>
        <article class="markdown">
          <h2 class="shortDescription"></h2>
          <div class="content">
            <p class="lead">
    In this article we will measure performance of seeking with HTMLVideoElement.
</p>
<h2>Why is this important?</h2>
<p>Let's say we are building a video editor application. In the video editor user can upload it's own video, apply some effects, transformations, etc. and then render the final video.
When rendering happens we should render the video frame by frame, which means we should seek to the specific time and then render the frame.</p>
<h2>How to seek html video element?</h2>
<p>To seek to a specific time in the video we can use <code>currentTime</code> property of the video element.</p>
<pre class="language-javascript"><code class="language-javascript"><span class="token keyword">const</span> video <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span><span class="token string">'video'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
video<span class="token punctuation">.</span>currentTime <span class="token operator">=</span> <span class="token number">10</span><span class="token punctuation">;</span> <span class="token comment">// Seek to 10th second</span></code></pre>
<p>but this is not correct, because seeking is an asynchronous operation. So we should listen to <code>seeked</code> event to know when seeking is done</p>
<pre class="language-javascript"><code class="language-javascript"><span class="token keyword">const</span> video <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span><span class="token string">'video'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
video<span class="token punctuation">.</span>currentTime <span class="token operator">=</span> <span class="token number">10</span><span class="token punctuation">;</span> <span class="token comment">// Seek to 10th second</span>
video<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'seeked'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'Seeking is done'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
<p>or lets make it generic</p>
<pre class="language-javascript"><code class="language-javascript"><span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">seek</span><span class="token punctuation">(</span><span class="token parameter">videElement<span class="token punctuation">,</span> currentTime</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> <span class="token function-variable function">listener</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
            videElement<span class="token punctuation">.</span><span class="token function">removeEventListener</span><span class="token punctuation">(</span><span class="token string">'seeked'</span><span class="token punctuation">,</span> listener<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
        videElement<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'seeked'</span><span class="token punctuation">,</span> listener<span class="token punctuation">)</span><span class="token punctuation">;</span>
        videElement<span class="token punctuation">.</span>currentTime <span class="token operator">=</span> currentTime<span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">await</span> <span class="token function">seek</span><span class="token punctuation">(</span>video<span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
<h2>Performance measurement tool</h2>
<p>In this demo you can chose video you like, edit timestamps and run the test.</p>
<div>
    <demo-with-playground file="mediaSource/index.html" initialPath="./mediaSource/index.html">
</demo-with-playground></div>
<h2>Test videos</h2>
<p>There are links to standard video files, but you can also upload your own video.</p>
<p>For tests we will use <a href="http://bbb3d.renderfarming.net/download.html">big buck bunny</a> video files with different resolutions and frame rates, iframes density, etc.</p>
<p>Info about the video files:</p>
<table>
<thead>
<tr>
<th>filename</th>
<th>iframes count</th>
<th>pframes count</th>
<th>bframes count</th>
<th>size in mb</th>
<th>has audio</th>
</tr>
</thead>
<tbody>
<tr>
<td><a href="https://media.githubusercontent.com/media/stepancar/articles/main/articles/html-video-element-seeking/mediaSource/test-videos/bbb_sunflower_1min_1080p_30fps_normal.mp4">bbb_sunflower_1min_1080p_30fps_normal.mp4</a></td>
<td>11</td>
<td>512</td>
<td>1277</td>
<td>29</td>
<td>yes</td>
</tr>
<tr>
<td><a href="https://media.githubusercontent.com/media/stepancar/articles/main/articles/html-video-element-seeking/mediaSource/test-videos/bbb_sunflower_1min_1080p_30fps_normal_10_times_more_iframes.mp4">bbb_sunflower_1min_1080p_30fps_normal_10_times_more_iframes.mp4</a></td>
<td>153</td>
<td>500</td>
<td>1147</td>
<td>52</td>
<td>yes</td>
</tr>
<tr>
<td><a href="https://media.githubusercontent.com/media/stepancar/articles/main/articles/html-video-element-seeking/mediaSource/test-videos/bbb_sunflower_1min_1080p_30fps_normal_10_times_more_iframes_no_audio.mp4">bbb_sunflower_1min_1080p_30fps_normal_10_times_more_iframes_no_audio.mp4</a></td>
<td>153</td>
<td>500</td>
<td>1147</td>
<td>53</td>
<td>yes</td>
</tr>
<tr>
<td><a href="https://media.githubusercontent.com/media/stepancar/articles/main/articles/html-video-element-seeking/mediaSource/test-videos/bbb_sunflower_1min_1080p_30fps_normal_20_times_more_iframes.mp4">bbb_sunflower_1min_1080p_30fps_normal_20_times_more_iframes.mp4</a></td>
<td>305</td>
<td>621</td>
<td>874</td>
<td>76</td>
<td>yes</td>
</tr>
<tr>
<td><a href="https://media.githubusercontent.com/media/stepancar/articles/main/articles/html-video-element-seeking/mediaSource/test-videos/bbb_sunflower_1min_1080p_30fps_normal_noaudio.mp4">bbb_sunflower_1min_1080p_30fps_normal_noaudio.mp4</a></td>
<td>11</td>
<td>512</td>
<td>1277</td>
<td>26</td>
<td>no</td>
</tr>
<tr>
<td><a href="https://media.githubusercontent.com/media/stepancar/articles/main/articles/html-video-element-seeking/mediaSource/test-videos/bbb_sunflower_1min_1080p_60fps_normal.mp4">bbb_sunflower_1min_1080p_60fps_normal.mp4</a></td>
<td>17</td>
<td>1122</td>
<td>2461</td>
<td>33</td>
<td>yes</td>
</tr>
<tr>
<td><a href="https://media.githubusercontent.com/media/stepancar/articles/main/articles/html-video-element-seeking/mediaSource/test-videos/bbb_sunflower_1min_1080p_60fps_normal_10_times_more_iframes.mp4">bbb_sunflower_1min_1080p_60fps_normal_10_times_more_iframes.mp4</a></td>
<td>168</td>
<td>1042</td>
<td>2390</td>
<td>55</td>
<td>yes</td>
</tr>
<tr>
<td><a href="https://media.githubusercontent.com/media/stepancar/articles/main/articles/html-video-element-seeking/mediaSource/test-videos/bbb_sunflower_1min_1080p_60fps_normal_noaudio.mp4">bbb_sunflower_1min_1080p_60fps_normal_noaudio.mp4</a></td>
<td>17</td>
<td>1122</td>
<td>2461</td>
<td>31</td>
<td>no</td>
</tr>
<tr>
<td><a href="https://media.githubusercontent.com/media/stepancar/articles/main/articles/html-video-element-seeking/mediaSource/test-videos/bbb_sunflower_1min_2160p_30fps_normal.mp4">bbb_sunflower_1min_2160p_30fps_normal.mp4</a></td>
<td>11</td>
<td>481</td>
<td>1308</td>
<td>75</td>
<td>yes</td>
</tr>
<tr>
<td><a href="https://media.githubusercontent.com/media/stepancar/articles/main/articles/html-video-element-seeking/mediaSource/test-videos/bbb_sunflower_1min_2160p_30fps_normal_10_times_more_iframes.mp4">bbb_sunflower_1min_2160p_30fps_normal_10_times_more_iframes.mp4</a></td>
<td>153</td>
<td>489</td>
<td>1158</td>
<td>142</td>
<td>yes</td>
</tr>
<tr>
<td><a href="https://media.githubusercontent.com/media/stepancar/articles/main/articles/html-video-element-seeking/mediaSource/test-videos/bbb_sunflower_1min_2160p_30fps_normal_noaudio.mp4">bbb_sunflower_1min_2160p_30fps_normal_noaudio.mp4</a></td>
<td>11</td>
<td>481</td>
<td>1308</td>
<td>73</td>
<td>no</td>
</tr>
<tr>
<td><a href="https://media.githubusercontent.com/media/stepancar/articles/main/articles/html-video-element-seeking/mediaSource/test-videos/bbb_sunflower_1min_2160p_60fps_normal.mp4">bbb_sunflower_1min_2160p_60fps_normal.mp4</a></td>
<td>16</td>
<td>748</td>
<td>2836</td>
<td>64</td>
<td>yes</td>
</tr>
<tr>
<td><a href="https://media.githubusercontent.com/media/stepancar/articles/main/articles/html-video-element-seeking/mediaSource/test-videos/bbb_sunflower_1min_2160p_60fps_normal_10_times_more_iframes.mp4">bbb_sunflower_1min_2160p_60fps_normal_10_times_more_iframes.mp4</a></td>
<td>168</td>
<td>1017</td>
<td>2420</td>
<td>156</td>
<td>yes</td>
</tr>
<tr>
<td><a href="https://media.githubusercontent.com/media/stepancar/articles/main/articles/html-video-element-seeking/mediaSource/test-videos/bbb_sunflower_1min_2160p_60fps_normal_noaudio.mp4">bbb_sunflower_1min_2160p_60fps_normal_noaudio.mp4</a></td>
<td>16</td>
<td>748</td>
<td>2836</td>
<td>61</td>
<td>no</td>
</tr>
<tr>
<td><a href="https://media.githubusercontent.com/media/stepancar/articles/main/articles/html-video-element-seeking/mediaSource/test-videos/bbb_sunflower_1min_480p_30fps_normal.mp4">bbb_sunflower_1min_480p_30fps_normal.mp4</a></td>
<td>12</td>
<td>623</td>
<td>1165</td>
<td>10</td>
<td>yes</td>
</tr>
<tr>
<td><a href="https://media.githubusercontent.com/media/stepancar/articles/main/articles/html-video-element-seeking/mediaSource/test-videos/bbb_sunflower_1min_480p_30fps_normal_10_times_more_iframes.mp4">bbb_sunflower_1min_480p_30fps_normal_10_times_more_iframes.mp4</a></td>
<td>153</td>
<td>598</td>
<td>1049</td>
<td>16</td>
<td>yes</td>
</tr>
<tr>
<td><a href="https://media.githubusercontent.com/media/stepancar/articles/main/articles/html-video-element-seeking/mediaSource/test-videos/bbb_sunflower_1min_480p_30fps_normal_noaudio.mp4">bbb_sunflower_1min_480p_30fps_normal_noaudio.mp4</a></td>
<td>12</td>
<td>623</td>
<td>1165</td>
<td>8</td>
<td>no</td>
</tr>
<tr>
<td><a href="https://media.githubusercontent.com/media/stepancar/articles/main/articles/html-video-element-seeking/mediaSource/test-videos/bbb_sunflower_1min_480p_60fps_normal.mp4">bbb_sunflower_1min_480p_60fps_normal.mp4</a></td>
<td>17</td>
<td>1360</td>
<td>2223</td>
<td>11</td>
<td>yes</td>
</tr>
<tr>
<td><a href="https://media.githubusercontent.com/media/stepancar/articles/main/articles/html-video-element-seeking/mediaSource/test-videos/bbb_sunflower_1min_480p_60fps_normal_10_times_more_iframes.mp4">bbb_sunflower_1min_480p_60fps_normal_10_times_more_iframes.mp4</a></td>
<td>168</td>
<td>1304</td>
<td>2128</td>
<td>17</td>
<td>yes</td>
</tr>
<tr>
<td><a href="https://media.githubusercontent.com/media/stepancar/articles/main/articles/html-video-element-seeking/mediaSource/test-videos/bbb_sunflower_1min_480p_60fps_normal_noaudio.mp4">bbb_sunflower_1min_480p_60fps_normal_noaudio.mp4</a></td>
<td>17</td>
<td>1360</td>
<td>2223</td>
<td>9</td>
<td>no</td>
</tr>
<tr>
<td><a href="https://media.githubusercontent.com/media/stepancar/articles/main/articles/html-video-element-seeking/mediaSource/test-videos/bbb_sunflower_1min_720p_30fps_normal.mp4">bbb_sunflower_1min_720p_30fps_normal.mp4</a></td>
<td>12</td>
<td>531</td>
<td>1257</td>
<td>16</td>
<td>yes</td>
</tr>
<tr>
<td><a href="https://media.githubusercontent.com/media/stepancar/articles/main/articles/html-video-element-seeking/mediaSource/test-videos/bbb_sunflower_1min_720p_30fps_normal_10_times_more_iframes.mp4">bbb_sunflower_1min_720p_30fps_normal_10_times_more_iframes.mp4</a></td>
<td>153</td>
<td>515</td>
<td>1132</td>
<td>28</td>
<td>yes</td>
</tr>
<tr>
<td><a href="https://media.githubusercontent.com/media/stepancar/articles/main/articles/html-video-element-seeking/mediaSource/test-videos/bbb_sunflower_1min_720p_30fps_normal_noaudio.mp4">bbb_sunflower_1min_720p_30fps_normal_noaudio.mp4</a></td>
<td>12</td>
<td>531</td>
<td>1257</td>
<td>14</td>
<td>no</td>
</tr>
<tr>
<td><a href="https://media.githubusercontent.com/media/stepancar/articles/main/articles/html-video-element-seeking/mediaSource/test-videos/bbb_sunflower_1min_720p_60fps_normal.mp4">bbb_sunflower_1min_720p_60fps_normal.mp4</a></td>
<td>17</td>
<td>1238</td>
<td>2345</td>
<td>19</td>
<td>yes</td>
</tr>
<tr>
<td><a href="https://media.githubusercontent.com/media/stepancar/articles/main/articles/html-video-element-seeking/mediaSource/test-videos/bbb_sunflower_1min_720p_60fps_normal_10_times_more_iframes.mp4">bbb_sunflower_1min_720p_60fps_normal_10_times_more_iframes.mp4</a></td>
<td>168</td>
<td>1215</td>
<td>2217</td>
<td>30</td>
<td>yes</td>
</tr>
<tr>
<td><a href="https://media.githubusercontent.com/media/stepancar/articles/main/articles/html-video-element-seeking/mediaSource/test-videos/bbb_sunflower_1min_720p_60fps_normal_noaudio.mp4">bbb_sunflower_1min_720p_60fps_normal_noaudio.mp4</a></td>
<td>17</td>
<td>1238</td>
<td>2345</td>
<td>16</td>
<td>no</td>
</tr>
<tr>
<td><a href="https://media.githubusercontent.com/media/stepancar/articles/main/articles/html-video-element-seeking/mediaSource/test-videos/bbb_sunflower_7sec_1080p_30fps_normal.mp4">bbb_sunflower_7sec_1080p_30fps_normal.mp4</a></td>
<td>3</td>
<td>62</td>
<td>147</td>
<td>2</td>
<td>yes</td>
</tr>
<tr>
<td><a href="https://media.githubusercontent.com/media/stepancar/articles/main/articles/html-video-element-seeking/mediaSource/test-videos/bbb_sunflower_7sec_1080p_30fps_normal_allframes.mp4">bbb_sunflower_7sec_1080p_30fps_normal_allframes.mp4</a></td>
<td>212</td>
<td>0</td>
<td>0</td>
<td>7</td>
<td>yes</td>
</tr>
<tr>
<td><a href="https://media.githubusercontent.com/media/stepancar/articles/main/articles/html-video-element-seeking/mediaSource/test-videos/bbb_sunflower_7sec_1080p_30fps_normal_alliframes.mp4">bbb_sunflower_7sec_1080p_30fps_normal_alliframes.mp4</a></td>
<td>212</td>
<td>0</td>
<td>0</td>
<td>2</td>
<td>yes</td>
</tr>
<tr>
<td><a href="https://media.githubusercontent.com/media/stepancar/articles/main/articles/html-video-element-seeking/mediaSource/test-videos/bbb_sunflower_7sec_1080p_30fps_one_iframe.mp4">bbb_sunflower_7sec_1080p_30fps_one_iframe.mp4</a></td>
<td>1</td>
<td>60</td>
<td>151</td>
<td>3</td>
<td>yes</td>
</tr>
<tr>
<td><a href="https://media.githubusercontent.com/media/stepancar/articles/main/articles/html-video-element-seeking/mediaSource/test-videos/video-seek-test-optimized.mp4">video-seek-test-optimized.mp4</a></td>
<td>2</td>
<td>49</td>
<td>140</td>
<td>2</td>
<td>no</td>
</tr>
</tbody>
</table>
<h3>Conclusion</h3>
<p>Chromium seek operation has O(n) complexity. Which means O(n^2) complexity to get all frames in the video;
To prove it I created a video with only one I-frame. This video has 301 frames and 7 seconds duration. The video is encoded with 30 fps, which means it has 210 frames per second. The video is encoded with 9999 keyframes, which means it has only one I-frame.</p>
<p>You can use this 2 videos to test the performance of seeking</p>
<p><a href="https://media.githubusercontent.com/media/stepancar/articles/main/articles/html-video-element-seeking/mediaSource/test-videos/bbb_sunflower_7sec_1080p_30fps_normal.mp4">normal video</a></p>
<p><a href="https://media.githubusercontent.com/media/stepancar/articles/main/articles/html-video-element-seeking/mediaSource/test-videos/bbb_sunflower_7sec_1080p_30fps_one_iframe.mp4">video with one i-frame</a></p>
<p>this video was creted by using ffmpeg command:</p>
<pre class="language-bash"><code class="language-bash">ffmpeg <span class="token parameter variable">-i</span> bbb_sunflower_7sec_1080p_30fps_normal.mp4 <span class="token punctuation">\</span>
  <span class="token parameter variable">-c:v</span> libx264 <span class="token parameter variable">-g</span> <span class="token number">9999</span> <span class="token parameter variable">-keyint_min</span> <span class="token number">9999</span> <span class="token parameter variable">-sc_threshold</span> <span class="token number">0</span> <span class="token punctuation">\</span>
  <span class="token parameter variable">-force_key_frames</span> <span class="token string">"0"</span> <span class="token parameter variable">-pix_fmt</span> yuv420p <span class="token punctuation">\</span>
  <span class="token parameter variable">-preset</span> fast <span class="token parameter variable">-crf</span> <span class="token number">18</span> <span class="token punctuation">\</span>
  bbb_sunflower_7sec_1080p_30fps_one-iframe.mp4</code></pre>
<p>On my machine running this experiment showed such results:</p>
<table>
<thead>
<tr>
<th>Browser</th>
<th>Video Type</th>
<th>Total Frames</th>
<th>Total Time (ms)</th>
<th>Seeking Time per Frame (ms)</th>
<th>Seeking FPS</th>
</tr>
</thead>
<tbody>
<tr>
<td>Chromium</td>
<td>Normal</td>
<td>301</td>
<td>5561.60</td>
<td>18.48</td>
<td>54.12</td>
</tr>
<tr>
<td>Chromium</td>
<td>Normal (1 I-frame)</td>
<td>301</td>
<td>9485.30</td>
<td>31.51</td>
<td>31.73</td>
</tr>
<tr>
<td>Safari</td>
<td>Normal</td>
<td>301</td>
<td>844.00</td>
<td>2.80</td>
<td>356.64</td>
</tr>
<tr>
<td>Safari</td>
<td>Normal (1 I-frame)</td>
<td>301</td>
<td>1134.00</td>
<td>3.77</td>
<td>265.43</td>
</tr>
</tbody>
</table>
<p><a href="https://issues.chromium.org/issues/418456081">chromium issue</a></p>
<p>You can also compare performance with <code>Preload to blob storage</code> option.
This option will preload video to blob storage and then you can seek to any time in the video without waiting for the video chunk to be loaded.</p>

          </div>
        </article>
      </main>
      <footer></footer>
    </layout>

    <script>
        function resizeIframe(iframe) {
            const height = parseInt(iframe.style.height);
            const scrollHeight = iframe.contentWindow.document.documentElement.scrollHeight
            iframe.style.height = scrollHeight + 'px';
            console.log(height, scrollHeight)
            if (height < scrollHeight) {  
              console.log('resize')
              iframe.style.height = scrollHeight + 20 + 'px';
            }
        }

        setInterval(() => {
            const iframes = document.querySelectorAll('iframe');
            iframes.forEach((iframe) => {
              resizeIframe(iframe);
            });
        }, 100);


    class DemoWithPlayground extends HTMLElement {
      static get observedAttributes() {
        return ['initialPath', 'file'];
      }

      constructor() {
          super();
              // this.attachShadow({ mode: 'open' });
          }

          connectedCallback() {
              this.render();
          }

          attributeChangedCallback() {
              this.render();
          }

          render() {
              const initialPath = this.getAttribute('initialPath') || '';
              const file = this.getAttribute('file') || '';
          
          this.innerHTML = `
          <div>
              <iframe src="./${initialPath}"></iframe>

              <a href="https://stackblitz.com/github/stepancar/articles/tree/main/articles/html-video-element-seeking/?file=${file}&initialPath=${initialPath}&startScript=start" target="_blank">
              <img
                  alt="Open in StackBlitz"
                  src="https://developer.stackblitz.com/img/open_in_stackblitz.svg"
              />
              </a>
          </div>
          `;
          }
      }

    customElements.define('demo-with-playground', DemoWithPlayground);
    </script>
  </body>
</html>
