<!doctype html>
<html xmlns="http://www.w3.org/1999/html">
<head>
    <meta charset="utf8" />
    <title>LibAVJS WebCodecs Streaming Transcode Example</title>
</head>
<body>
<script type="text/javascript" src="https://cdn.jsdelivr.net/npm/@libav.js/variant-webcodecs@6.5.7/dist/libav-6.5.7.1-webcodecs.js"></script>
<script type="text/javascript" src="https://cdn.jsdelivr.net/npm/libavjs-webcodecs-bridge@0.3.2"></script>
<script type="text/javascript" src="https://cdn.jsdelivr.net/npm/@libav.js/variant-webcodecs@6.5.7/dist/libav-6.5.7.1-webcodecs.wasm.js"></script>

<div id="input-box">
    <label for="container">Container type:&nbsp;</label>
    <select id="container">
        <option value="webm">WEBM</option>
        <option value="mp4">MP4</option>
        <option value="mkv">MKV (Matroska)</option>
        <option value="mov">MOV (QuickTime)</option>
        <option value="flv">FLV (Flash Video)</option>
        <option value="ts">TS (MPEG-TS)</option>
    </select><br/>

    <label for="resolution">Resolution type:&nbsp;</label>
    <select id="resolution">
        <option value="1920x1080">1080p (1920x1080)</option>
        <option value="1280x720">720p (1280x720)</option>
        <option value="640x480">480p (640x480)</option>
        <option value="3840x2160">4K (3840x2160)</option>
        <option value="2560x1440">1440p (2560x1440)</option>
        <option value="1280x960">XGA+ (1280x960)</option>
        <option value="854x480">FWVGA (854x480)</option>
        <option value="320x240">QVGA (320x240)</option>
    </select><br/>

    <label for="file">Input file:&nbsp;</label>
    <input type="file" id="file" />

    <button id="start-transcode">Start Transcoding</button>
</div>

<script type="text/javascript">
  const worker = new Worker('worker.js');

  document.getElementById('start-transcode').addEventListener('click', async () => {
    const file = document.getElementById('file').files[0];
    if (!file) {
      alert('Please select a file.');
      return;
    }

    const container = document.getElementById('container').value;
    const resolution = document.getElementById('resolution').value;
    const [width, height] = resolution.split('x').map(Number);

    const formats = {
      "webm": ["vp9", "opus", "video/webm"],
      "mp4": ["avc1.42403e", "mp4a.40.2", "video/mp4"],
      "mkv": ["avc1.42403e", "opus", "video/x-matroska"],
      "mov": ["avc1.42403e", "mp4a.40.2", "video/quicktime"],
      "flv": ["avc1.42403e", "mp4a.40.2", "video/x-flv"],
      "ts": ["avc1.42403e", "mp4a.40.2", "video/mp2t"],
    };

    const [vc, ac, mimeType] = formats[container];

    // Read the file as an ArrayBuffer
    const arrayBuffer = await file.arrayBuffer();

    // Send data to the worker
    worker.postMessage({
      file: arrayBuffer,
      container,
      vc,
      ac,
      mimeType,
      width,
      height,
    }, [arrayBuffer]);

    worker.onmessage = (event) => {
      const { output } = event.data;

      console.log(output)
      // Create a Blob and download the file
      // const blob = new Blob([output], { type: mimeType });
      // const url = URL.createObjectURL(blob);
      // const a = document.createElement('a');
      // a.href = url;
      // a.download = `output.${container}`;
      // document.body.appendChild(a);
      // a.click();
      // document.body.removeChild(a);
    };
  });
</script>
</body>
</html>